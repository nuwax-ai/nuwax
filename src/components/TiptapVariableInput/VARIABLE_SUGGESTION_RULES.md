# Variable Suggestion Trigger and Replacement Rules

## 触发规则 (Trigger Rules)

### ✅ 应该触发建议框的场景

1. **单个左大括号后**

   - 输入: `{|`
   - 行为: 显示变量建议框
   - 选中变量后: `{{xxx}}`

2. **大括号对中间**

   - 输入: `{|}`
   - 行为: 显示变量建议框
   - 选中变量后: `{{xxx}}`

3. **两个完整变量之间**

   - 输入: `{{xxx}}{|{{yy}}`
   - 行为: 显示变量建议框
   - 选中变量后: `{{xxx}}{{zzz}}{{yy}}`

4. **变量内部编辑**

   - 输入: `{{xx|x}}`
   - 行为: 显示变量建议框
   - 选中变量后: **完整替换**整个变量为 `{{yyy}}` 或工具变量

5. **普通文本中间**

   - 输入: `12dsds212|` (然后输入 `{`)
   - 行为: **触发**
   - 原因: 允许在任何位置插入变量

### ❌ 不应该触发建议框的场景

1. **变量后的普通文本**

   - 输入: `{{yy}}x|xx`
   - 行为: 不触发（光标在普通文本 `xxx` 中间）
   - 原因: 光标前既不是 `{`，也不在 `{{...}}` 内部

2. **变量之间有普通文本（文本开头）**

   - 输入: `{{{xxx}}|zzz{{yy}}`
   - 行为: 不触发（即使输入 `{`，因为中间有普通文本 `zzz`）
   - 原因: 只允许在两个**紧邻**的变量之间插入，不允许在已有文本的位置插入

3. **变量之间有普通文本（文本结尾）**

   - 输入: `{{{xxx}}zzz|{{yy}}`
   - 行为: 不触发（光标在普通文本 `zzz` 中间）
   - 原因: 光标前既不是 `{`，也不在 `{{...}}` 内部

4. **普通文本中的左大括号**

   - 输入: `{{{xxx}}zz|z{{yy}}`
   - 行为: 不触发（光标在普通文本 `zzz` 中间，不在变量引用语法位置）
   - 原因: 光标前有 `}}` 且后面不是紧跟 `{{`

5. **变量右大括号之后紧跟**
   - 输入: `{{xxx}}|`
   - 行为: 不触发
   - 原因: 避免在已完成的变量后误触发

## 替换行为 (Replacement Behavior)

### 场景 1: 新插入变量

- 触发位置: `{|` 或 `{|}`
- 选中变量后:
  - 删除触发字符 `{` 或 `{}`
  - 插入完整变量: `{{variableName}}`

### 场景 2: 编辑已存在的变量

- 触发位置: `{{xx|x}}` (光标在变量内部)
- 选中变量后:
  - **完整替换**整个 `{{xxx}}` 为新的 `{{yyy}}`
  - **不是**部分修改，而是整体替换

### 场景 3: 插入工具块

- 触发位置: 任何允许触发的位置
- 选中工具后:
  - 插入工具块节点: `{#ToolBlock id="xxx" type="yyy" name="zzz"#}content{#/ToolBlock#}`

## 实现要点

### 触发检测 (Allow Function)

位置: `VariableSuggestion.tsx` - `allow` 函数

检查逻辑:

✅ 允许在普通文本中触发 2. ✅ 检查光标**前**的文本，阻止在 `}}` 紧跟后触发（除非后面紧跟 `{{`） 3. ✅ 允许在两个紧邻的变量之间插入（`{{xxx}}{|{{yy}}`）

### 范围计算 (Range Detection)

- Tiptap Suggestion 插件自动计算触发字符 `{` 之后到光标的范围
- 这个范围用于在选中变量后执行替换

### 完整替换逻辑 (Complete Replacement)

当光标在变量内部 `{{xx|x}}` 时:

1. 检测光标是否在 `{{...}}` 内部
2. 如果是，计算整个变量的范围 (from `{{` to `}}`)
3. 替换整个范围为新的变量引用

## 测试用例

| 输入场景            | 光标位置     | 是否触发    | 选中后结果 |
| ------------------- | ------------ | ----------- | ---------- | ---------------------- |
| `{`                 | `{           | `           | ✅         | `{{xxx}}`              |
| `{}`                | `{           | }`          | ✅         | `{{xxx}}`              |
| `{{xxx}}{{yy}}`     | `{{xxx}}{    | {{yy}}`     | ✅         | `{{xxx}}{{zzz}}{{yy}}` |
| `12dsds212`         | `12dsds212   | ` (输入`{`) | ✅         | `12dsds212{{xxx}}`     |
| `{{yy}}xxx`         | `{{yy}}x     | xx`         | ❌         | N/A                    |
| `{{xxx}}zzz{{yy}}`  | `{{{xxx}}    | zzz{{yy}}`  | ❌         | N/A                    |
| `{{xxx}}zzz{{yy}}`  | `{{{xxx}}zzz | {{yy}}`     | ❌         | N/A                    |
| `{{{xxx}}zzz{{yy}}` | `{{{xxx}}zz  | z{{yy}}`    | ❌         | N/A                    |
| `{{xxx}}`           | `{{xx        | x}}`        | ✅         | `{{yyy}}` (完整替换)   |
| `{{xxx}}`           | `{{xxx}}     | `           | ❌         | N/A                    |

**核心规则**：

## 工具/技能/子智能体补全 (Tool/Skill/SubAgent Completion)

除了普通变量，组件还支持插入工具、技能和子智能体。

### 识别规则 (Identification Rules)

系统会自动识别以下类型的节点为"工具"：

1. **类型标识**：变量类型 (`type`) 为以下之一：

   - `Tool` (工具)
   - `Skill` (技能)
   - `SubAgent` (子智能体)
   - `Plugin` (插件)
   - `Workflow` (工作流)
   - `Mcp` (MCP 工具)

2. **Key 前缀**：变量 `key` 以以下前缀开头：
   - `tool-`
   - `skill-`
   - `subagent-`

### 插入行为 (Insertion Behavior)

当选中一个工具类型的建议项时，行为与普通变量不同：

- **普通变量**: 插入 `{{variableName}}`
- **工具/技能**: 插入工具块节点 `{#ToolBlock id="..." type="..." name="..."#}content{#/ToolBlock#}`

### 详细测试用例 (Tool Test Cases)

| 场景 | 变量类型/Key | 选中后结果 (HTML/Text) | 说明 |
| --- | --- | --- | --- |
| **插入技能** | `type: 'Skill'` / `skill-123` | `{#ToolBlock id="123" type="skill" name="search"#}search{#/ToolBlock#}` | 插入完整的工具块结构 |
| **插入工具** | `type: 'Tool'` / `tool-abc` | `{#ToolBlock id="abc" type="tool" name="calculator"#}calculator{#/ToolBlock#}` | 工具块包含 ID、类型和名称 |
| **插入子智能体** | `type: 'SubAgent'` | `{#ToolBlock id="sa-001" type="sub-agent" name="writer"#}writer{#/ToolBlock#}` | 子智能体也使用 ToolBlock 渲染 |
| **混合列表选择** | 混合变量和工具 | 根据选中项类型决定是 `{{...}}` 还是 `{#ToolBlock...#}` | 列表会自动分类显示 Tabs |

### 交互差异

1. **Tabs 分类**: 当同时存在变量和工具时，建议框会自动显示 Tabs (Variables / Tools / Skills) 供切换。
2. **Tab 切换**: 支持使用 `Tab` 键在不同分类之间循环切换。
