# 滚动同步功能测试指南

## 测试目的

验证 PromptVariableRef 组件的滚动同步修复是否生效，确保在各种滚动场景下光标和下拉框位置都能正确显示。

## 测试场景

### 1. 基础滚动同步测试

**目标**: 验证输入框和高亮层的基本滚动同步

- [ ] 输入框出现滚动条时，高亮层同步滚动
- [ ] 滚动位置偏移量计算正确
- [ ] 滚动后下拉框位置不偏移

### 2. 水平滚动测试

**目标**: 验证水平滚动时的同步效果

- [ ] 输入框水平滚动条出现时，下拉框仍正确定位
- [ ] 高亮层水平滚动同步正确
- [ ] 光标位置计算考虑水平滚动偏移

### 3. 垂直滚动测试

**目标**: 验证垂直滚动时的同步效果

- [ ] 输入框垂直滚动条出现时，下拉框仍正确定位
- [ ] 高亮层垂直滚动同步正确
- [ ] 光标位置计算考虑垂直滚动偏移

### 4. 双向滚动测试

**目标**: 验证同时有水平和垂直滚动时的效果

- [ ] 同时滚动时同步效果正常
- [ ] 下拉框位置计算准确
- [ ] 滚动过程中无视觉闪烁

### 5. 自动完成时滚动测试

**目标**: 验证自动补全功能在滚动状态下的表现

- [ ] 输入`{`时弹出下拉框位置正确
- [ ] 自动补全后光标位置准确
- [ ] 滚动状态不影响自动补全

### 6. 变量选择时滚动测试

**目标**: 验证变量选择功能在滚动状态下的表现

- [ ] 变量树下拉框显示位置正确
- [ ] 变量选择后光标定位准确
- [ ] 滚动状态不影响变量选择

### 7. 一次性删除功能滚动测试

**目标**: 验证一次性删除功能在滚动状态下的表现

- [ ] 高亮区块在滚动状态下正确显示
- [ ] 滚动状态下删除高亮区块成功
- [ ] 删除后光标位置准确

### 8. 性能和流畅度测试

**目标**: 验证滚动同步的性能表现

- [ ] 滚动操作流畅，无明显卡顿
- [ ] 高频滚动时同步稳定
- [ ] requestAnimationFrame 优化生效

## 测试步骤

### 1. 准备测试环境

1. 打开示例页面 `/examples/ScrollTest/index.tsx`
2. 确保有足够的文本内容触发滚动条
3. 打开浏览器开发者工具查看控制台日志

### 2. 基础功能测试

1. 输入大量文本触发滚动条
2. 使用鼠标滚轮或滚动条滚动内容
3. 观察高亮层是否同步滚动
4. 检查下拉框位置是否正确

### 3. 交互测试

1. 输入`{`触发自动补全
2. 在滚动状态下选择变量
3. 测试一次性删除高亮区块
4. 验证光标定位准确性

### 4. 边界情况测试

1. 快速连续滚动
2. 边滚动边输入
3. 滚动到边缘位置
4. 窗口大小改变时的滚动

## 预期结果

### 成功指标

- ✅ 输入层和高亮层滚动完全同步
- ✅ 光标位置在任何滚动状态下都正确
- ✅ 下拉框位置正确跟随光标
- ✅ 滚动操作流畅无延迟
- ✅ 整体用户体验一致
- ✅ 控制台无滚动相关错误

### 失败标志

- ❌ 高亮层与输入层滚动不同步
- ❌ 下拉框位置偏离光标
- ❌ 滚动时出现视觉闪烁
- ❌ 控制台出现滚动错误
- ❌ 滚动操作有卡顿

## 调试信息

### 控制台日志

修复后的组件会在以下情况下输出调试信息：

1. 滚动同步时：`Scroll synced: {scrollTop, scrollLeft, visible}`
2. 光标重新计算：`Enhanced cursor calculation: {cursorX, cursorY, scrollLeft, scrollTop}`
3. 自动补全光标计算：`Auto-complete cursor calculation enhanced: {...}`
4. 变量应用光标计算：`Variable apply cursor calculation enhanced: {...}`
5. 内容变化滚动同步：`Content changed, syncing scroll: {...}`

### 性能监控

观察滚动同步的性能表现：

1. 滚动时是否有帧率下降
2. 连续滚动时是否有累积延迟
3. requestAnimationFrame 是否生效

## 故障排除

### 常见问题

1. **同步延迟**: 检查是否有 CSS 冲突或 DOM 更新延迟
2. **位置偏移**: 检查滚动偏移计算是否正确
3. **性能问题**: 检查是否有过度重渲染或重复计算

### 调试步骤

1. 打开控制台查看滚动日志
2. 检查 DOM 元素的滚动属性
3. 验证 CSS 样式是否影响滚动
4. 确认事件监听器是否正常

## 后续优化

基于测试结果，可能需要进一步优化：

1. 滚动事件节流
2. 更好的性能优化
3. 更多边界情况处理
4. 用户体验细节改进
