import SvgIcon from '@/components/base/SvgIcon';
import { jumpBack } from '@/utils/router';
import { RocketOutlined, UserOutlined } from '@ant-design/icons';
import { Avatar, Button, Tag, Tooltip } from 'antd';
import classNames from 'classnames';
import dayjs from 'dayjs';
import React from 'react';
import styles from './AppDevHeader.less';

const cx = classNames.bind(styles);

export interface AppDevHeaderProps {
  workspace: {
    name?: string;
    projectId?: string;
  };
  onReloadProject?: () => void;
  onDeleteProject?: () => void;
  onDeployProject?: () => void;
  hasUpdates?: boolean;
  lastSaveTime?: Date;
  isDeploying?: boolean;
  /** 项目详情信息 */
  projectInfo?: {
    name?: string;
    description?: string;
    buildRunning?: number;
    buildTime?: string;
    creatorName?: string;
    creatorNickName?: string;
    creatorAvatar?: string;
  };
  /** 部署状态相关方法 */
  getDeployStatusText?: (buildRunning: number) => string;
  getDeployStatusColor?: (buildRunning: number) => string;
}

/**
 * AppDev 页面顶部头部组件
 * 统一了 EditAgent 页面的头部样式和交互模式
 */
const AppDevHeader: React.FC<AppDevHeaderProps> = ({
  workspace,
  onDeployProject,
  hasUpdates = true,
  lastSaveTime = new Date(),
  isDeploying = false,
  projectInfo,
  getDeployStatusText,
  getDeployStatusColor,
}) => {
  // 获取项目名称，优先使用接口数据
  const projectName = projectInfo?.name || workspace.name || '大模型三部曲';

  // 获取创建者信息
  const creatorName =
    projectInfo?.creatorNickName || projectInfo?.creatorName || '未知用户';
  const creatorAvatar = projectInfo?.creatorAvatar;

  // 获取部署状态
  const deployStatus = projectInfo?.buildRunning;
  const deployStatusText =
    deployStatus !== undefined && getDeployStatusText
      ? getDeployStatusText(deployStatus)
      : '未知状态';
  const deployStatusColor =
    deployStatus !== undefined && getDeployStatusColor
      ? getDeployStatusColor(deployStatus)
      : 'default';

  // 获取最后发布时间
  const lastDeployTime = projectInfo?.buildTime
    ? dayjs(projectInfo.buildTime).format('YYYY-MM-DD HH:mm')
    : null;

  return (
    <header className={cx('flex', 'items-center', 'relative', styles.header)}>
      <SvgIcon
        name="icons-nav-backward"
        className={cx(styles['icon-backward'])}
        onClick={() => jumpBack('/')}
      />
      <Avatar
        size={27}
        icon={<UserOutlined />}
        className={cx(styles.avatar)}
        src={creatorAvatar}
      />
      <div className={cx('flex', 'flex-col', styles['header-info'])}>
        <div className={cx('flex', 'items-center')}>
          <h3 className={cx(styles['h-title'], 'text-ellipsis')}>
            {projectName}
          </h3>
          <div className={cx('flex', 'items-center', styles['agent-rel-info'])}>
            <span className={cx(styles['space-name'], 'text-ellipsis')}>
              {projectName}
            </span>
            {workspace.projectId && (
              <span className={cx(styles['project-id'])}>
                项目ID: {workspace.projectId}
              </span>
            )}
            {/* 部署状态标签 */}
            {deployStatus !== undefined && (
              <Tag
                color={deployStatusColor}
                className={cx(styles['deploy-status-tag'])}
              >
                {deployStatusText}
              </Tag>
            )}
          </div>
        </div>
        {/* 项目描述 */}
        {/* {projectInfo?.description && (
          <div className={cx(styles['project-description'])}>
            {projectInfo.description}
          </div>
        )} */}
      </div>
      <div className={cx(styles['right-box'], 'flex', 'items-center')}>
        <div className={cx('flex', 'items-center', styles['save-time-box'])}>
          <span className={cx(styles['save-time'])}>
            草稿自动保存于&nbsp;
            {dayjs(lastSaveTime).format('HH:mm')}
          </span>
          {hasUpdates && (
            <Tag
              bordered={false}
              color="volcano"
              className={cx(styles['volcano'])}
            >
              有更新未部署
            </Tag>
          )}
          {/* 最后发布时间 */}
          {lastDeployTime && (
            <span className={cx(styles['deploy-time'])}>
              最后发布: {lastDeployTime}
            </span>
          )}
        </div>
        <div className={cx('flex', 'items-center', styles['action-buttons'])}>
          {/* <Button
            size="small"
            className={styles.navButton}
            onClick={onReloadProject}
          >
            重新加载项目
          </Button> */}
          {/* <Button
            size="small"
            danger
            className={styles.actionButton}
            onClick={onDeleteProject}
          >
            删除
          </Button> */}
          <Tooltip
            title={
              isDeploying
                ? '正在部署项目...'
                : '部署项目到生产环境 (Ctrl/Cmd + D)'
            }
          >
            <Button
              type="primary"
              size="small"
              className={styles.deployButton}
              onClick={onDeployProject}
              loading={isDeploying}
              disabled={isDeploying}
              icon={isDeploying ? undefined : <RocketOutlined />}
            >
              {isDeploying ? '部署中...' : '部署'}
            </Button>
          </Tooltip>
        </div>
      </div>
    </header>
  );
};

export default AppDevHeader;
