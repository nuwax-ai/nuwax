# V1 / V2 工作流设计准则

> 目标：明确 V2 与 V1 的差异点与对齐策略，确保前端联动与全量同步一致。

## 1. 核心差异

- **数据源**：V2 由前端 `nodeList` / `edgeList` 作为唯一数据源，接口只做持久化。
- **变量向上引用**：V2 在前端计算（`variableReferenceV2`），不依赖后端。
- **全量保存**：V2 采用全量同步（保存时一次提交全部节点/连线）。

## 2. 前端操作准则

- **新增/删除节点、更新节点属性（含端口、边）**：前端立即更新画布与数据层；保存时走全量同步。若后续需要接口预占 ID，可在前端更新后再补充接口调用。
- **连线添加/删除**：前端即时更新（含 `nextNodeIds` 与 `edgeList`），保存时全量提交。
- **节点属性面板联动**：面板变更必须调用 `graphUpdateByFormData`，保持端口、尺寸、关联边同步。

## 3. 试运行 / 发布

- 保持与 V1 相同的逻辑与流程（试运行校验、发布前校验依旧沿用 V1 规则）。
- 工作流整体校验、试运行入口与交互按 V1 体验；数据来源为 V2 前端态。

## 4. 路由与端口对齐（与 V1 保持一致）

- **路由器**：初始化批量添加边用 `orth`；交互拖拽与连线完成后用 `manhattan`。
- **端口 ID**：`${node.id}-${uuid}-out`，异常端口 `${node.id}-exception-out`；`sourcePort` 必须与端口 ID 完全一致。
- **连线置顶与层级**：异常/循环连线 `edge.toFront()`；循环内 zIndex=15，普通=1。

## 5. 保存策略

- 默认关闭自动保存；手动保存时全量提交。
- 撤销/重做基于前端快照（最大 50 步），与画布历史保持同步。

## 6. 回归关注点

- 节点属性面板改动后画布端口/尺寸/边实时联动。
- 特殊节点（条件分支、意图识别、问答选项、异常处理）端口变更会删除失效边。
- 异常端口、循环节点连线渲染无回折，层级正确。
