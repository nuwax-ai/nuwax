# V2 工作流编辑器回归测试清单

> 本文档以 V1 已实现功能为基准，对照 V2 进行回归测试验证实现详情与规则说明请参见《FEATURE_IMPLEMENTATION.md》

## 测试状态说明

- ✅ 已实现/测试通过
- 🚧 实现中/部分完成
- ❌ 未实现/未测试
- ⚠️ 有问题/需修复

---

## 迁移任务总览

| 任务 | 状态 | 优先级 | 备注 |
| --- | --- | --- | --- |
| 节点及连线增删改 | ✅ | P0 | 画布数据全量同步 |
| 迁移后端实现的校验 | ✅ | P0 | 引用变量查找逻辑已完成 |
| 功能回归对照调试 | 🚧 | P1 | 本清单追踪 |
| 接口联调 | ❌ | P1 | 待后端接口完善（保存/试运行/发布/版本历史） |
| 变量聚合节点添加 | ❌ | P2 | 新功能 |
| 数据更新同步问题 | ✅ | P1 | 数据层与画布同步 |

---

## 一、画布操作

> 对照 V1 画布基础交互功能

| V1 功能                     | V2 状态 | 测试结果 | 备注                 |
| --------------------------- | ------- | -------- | -------------------- |
| 画布拖拽平移                | ✅      |          | panning: true        |
| 画布缩放（鼠标滚轮）        | ✅      |          | mousewheel 配置      |
| 画布缩放（控制面板按钮）    | ✅      |          | ControlPanelV2       |
| 画布适应视图（Fit to View） | ✅      |          | graphChangeZoomToFit |
| 画布网格显示                | ✅      |          |                      |
| 画布背景色                  | ✅      |          |                      |
| 小地图导航                  | ❌      |          | V1 无此功能          |

---

## 二、节点操作

### 2.1 节点选择

| V1 功能                     | V2 状态 | 测试结果 | 备注             |
| --------------------------- | ------- | -------- | ---------------- |
| 单击选中节点                | ✅      |          | node:click 事件  |
| 选中节点高亮边框            | ✅      |          | Selection 插件   |
| 点击空白取消选中            | ✅      |          | blank:click 事件 |
| 多选节点（Ctrl/Cmd + 点击） | ✅      |          | Selection 插件   |
| 框选多个节点                | ✅      |          | Selection 插件   |

### 2.2 节点添加

| V1 功能 | V2 状态 | 测试结果 | 备注 |
| --- | --- | --- | --- |
| 点击节点面板添加节点 | ✅ |  | StencilContentV2 |
| 拖拽节点面板添加节点 | ✅ |  | onDragEnd 事件 |
| 从输出端口点击添加节点 | ✅ |  | node:port:click 事件 |
| 从输入端口点击添加节点 | ✅ |  | node:port:click 事件 |
| 在连线上插入节点 | ✅ |  | edge:mouseenter + button |
| 复制节点（Ctrl+C / Ctrl+V） | ✅ |  | EventHandlersV2 |
| 复制节点（右键菜单） | ✅ |  | 右键菜单支持复制/粘贴/删除 |

### 2.3 节点删除

| V1 功能 | V2 状态 | 测试结果 | 备注 |
| --- | --- | --- | --- |
| Delete/Backspace 键删除 | ✅ |  | EventHandlersV2 |
| 删除时弹出确认框（循环节点） | ✅ |  | modal.confirm |
| 开始/结束节点不可删除 | ✅ |  | NON_DELETABLE_NODE_TYPES_V2 |
| 删除节点自动删除关联连线 | ✅ |  | X6 自动处理 |

### 2.4 节点移动

| V1 功能              | V2 状态 | 测试结果 | 备注              |
| -------------------- | ------- | -------- | ----------------- |
| 拖拽移动节点         | ✅      |          | node:moved 事件   |
| 移动时连线自动跟随   | ✅      |          | X6 自动处理       |
| 循环节点内部节点移动 | ✅      |          | 父子关系绑定      |
| 移动后位置自动保存   | ✅      |          | onNodeChange 回调 |
| 方向键移动选中节点   | ✅      |          | EventHandlersV2   |

### 2.5 节点可视与运行反馈

| V1 功能 | V2 状态 | 测试结果 | 备注 |
| --- | --- | --- | --- |
| 节点标题可编辑并触发保存 | 🚧 |  | `EditableTitle` 触发 `node:custom:save` |
| 编辑标题时禁用拖拽 | 🚧 |  | `enableMove=false` during editing |
| 运行结果渲染（分页/只看错误/展开） | 🚧 |  | `NodeRunResultV2` 需验证状态与数据映射 |
| 异常处理区块展示 | 🚧 |  | 异常节点展示 `exceptionHandleType` |
| 循环节点拖拽与可调尺寸 | 🚧 |  | `draggable/resizable` on Loop 节点 |
| 运行态样式（running/success/error） | 🚧 |  | runResults 状态驱动类名 |

---

## 三、连线操作

### 3.1 连线创建

| V1 功能 | V2 状态 | 测试结果 | 备注 |
| --- | --- | --- | --- |
| 从输出端口拖拽创建连线 | ✅ |  | connecting 配置 |
| 连线自动吸附到输入端口 | ✅ |  | snap 配置 |
| 连线实时预览 | ✅ |  | createEdge |
| 防止自连接 | ✅ |  | validateConnection |
| 防止重复连接 | ✅ |  | validateConnection |
| 端口连接类型校验（out->in） | ✅ |  | validateConnection |
| 端口点击快捷添加+连线 | ✅ |  | handleCreateNodeByPortOrEdge |
| 边上点击插入节点+连线 | ✅ |  | handleCreateNodeByPortOrEdge |

### 3.2 连线渲染

| V1 功能                        | V2 状态 | 测试结果 | 备注             |
| ------------------------------ | ------- | -------- | ---------------- |
| 普通连线渲染                   | ✅      |          |                  |
| 曲线连接器（curveConnectorV2） | ✅      |          | 自定义连接器     |
| 连线箭头显示                   | ✅      |          | targetMarker     |
| 条件分支多输出端口连线         | ✅      |          | special 端口组   |
| 意图识别多输出端口连线         | ✅      |          | special 端口组   |
| 问答节点多输出端口连线         | ✅      |          | special 端口组   |
| 循环节点内部连线               | ✅      |          | zIndex 处理      |
| 异常处理端口连线               | ✅      |          | exception 端口组 |
| 初始化时连线无回折             | ✅      |          | orth 路由器      |

### 3.3 连线与端口联动

| V1 功能 | V2 状态 | 测试结果 | 备注 |
| --- | --- | --- | --- |
| 条件分支增删选项时端口联动 | ✅ |  | graphUpdateNode 处理端口变化 |
| 意图识别增删选项时端口联动 | ✅ |  | 删除端口时自动删除关联边 |
| 问答选项增删时端口联动 | ✅ |  | 删除端口时自动删除关联边 |
| 异常处理配置变化时端口联动 | ✅ |  | exception 端口显示/隐藏 |
| 循环内节点更新时父节点大小调整 | ✅ |  | adjustLoopNodeSize |
| 节点属性面板修改时画布端口/尺寸联动 | ✅ |  | graphUpdateByFormData 同步画布 |
| 循环节点默认内置 Start/End | ✅ |  | 创建循环时生成 innerNodes 与 innerStart/End |
| 循环内部添加节点限制 | ✅ |  | 仅选中循环或端口快捷添加，拖拽不入容器 |
| 节点属性面板修改时画布端口/尺寸联动 | ✅ |  | graphUpdateByFormData 同步画布 |

### 3.3 连线删除

| V1 功能                | V2 状态 | 测试结果 | 备注            |
| ---------------------- | ------- | -------- | --------------- |
| 选中连线后 Delete 删除 | ✅      |          | EventHandlersV2 |
| 删除节点自动删除连线   | ✅      |          | X6 自动处理     |
| 循环内部连线删除限制   | ✅      |          | canDeleteEdge   |

---

## 四、节点配置面板

### 4.1 面板基础

| V1 功能                      | V2 状态 | 测试结果 | 备注         |
| ---------------------------- | ------- | -------- | ------------ |
| 点击节点打开配置面板         | ✅      |          | NodeDrawerV2 |
| 关闭配置面板                 | ✅      |          |              |
| 节点名称显示                 | ✅      |          |              |
| 节点名称编辑                 | ✅      |          |              |
| 节点描述显示                 | ✅      |          |              |
| 操作菜单（复制/删除/试运行） | ✅      |          |              |

### 4.2 各节点类型配置

| 节点类型                | V1 功能 | V2 状态 | 备注                      |
| ----------------------- | ------- | ------- | ------------------------- |
| **开始节点 (Start)**    |         |         |                           |
| - 输入参数列表          | 有      | ✅      |                           |
| - 添加/删除参数         | 有      | ✅      |                           |
| - 参数名称编辑          | 有      | ✅      |                           |
| - 参数类型选择          | 有      | ✅      |                           |
| - 参数必填设置          | 有      | ✅      |                           |
| **结束节点 (End)**      |         |         |                           |
| - 返回类型切换          | 有      | ✅      |                           |
| - 输出变量选择          | 有      | ✅      |                           |
| - 输出内容编辑          | 有      | ✅      |                           |
| **LLM 大模型节点**      |         |         |                           |
| - 模型选择下拉          | 有      | ✅      |                           |
| - 系统提示词编辑器      | 有      | ✅      |                           |
| - 用户提示词编辑器      | 有      | ✅      |                           |
| - 提示词变量引用        | 有      | ✅      |                           |
| - 输入参数配置          | 有      | ✅      |                           |
| - 输出参数配置          | 有      | ✅      |                           |
| - 温度/TopP 参数        | 有      | ✅      |                           |
| - 技能组件选择          | 有      | ✅      | Created 选择器            |
| **代码节点 (Code)**     |         |         |                           |
| - 输入参数配置          | 有      | ✅      |                           |
| - 代码语言切换          | 有      | ✅      |                           |
| - Monaco 代码编辑器     | 有      | ✅      |                           |
| - 输出参数配置          | 有      | ✅      |                           |
| **HTTP 请求节点**       |         |         |                           |
| - 请求方法选择          | 有      | ✅      |                           |
| - URL 输入              | 有      | ✅      |                           |
| - Content-Type          | 有      | ✅      |                           |
| - 超时设置              | 有      | ✅      |                           |
| - Headers 编辑          | 有      | ✅      |                           |
| - Query 参数            | 有      | ✅      |                           |
| - Body 参数             | 有      | ✅      |                           |
| - 输出参数配置          | 有      | ✅      |                           |
| **条件分支节点**        |         |         |                           |
| - 条件分支列表          | 有      | ✅      | 拖拽排序                  |
| - IF/ELSE IF/ELSE       | 有      | ✅      | 自动重排                  |
| - 条件表达式编辑        | 有      | ✅      | 输入/引用                 |
| - 比较运算符选择        | 有      | ✅      | 校验必填                  |
| - 添加/删除分支         | 有      | ✅      | Form.List                 |
| **意图识别节点**        |         |         |                           |
| - 模型选择              | 有      | ✅      |                           |
| - 意图列表配置          | 有      | ✅      |                           |
| - 补充提示词            | 有      | ✅      |                           |
| **问答节点 (QA)**       |         |         |                           |
| - 问题内容编辑          | 有      | ✅      |                           |
| - 回答类型切换          | 有      | ✅      |                           |
| - 选项列表配置          | 有      | ✅      |                           |
| - 最大回复次数          | 有      | ✅      |                           |
| **循环节点 (Loop)**     |         |         |                           |
| - 循环类型选择          | 有      | ✅      |                           |
| - 循环次数设置          | 有      | ✅      |                           |
| - 循环数组变量选择      | 有      | ✅      |                           |
| - 循环变量配置          | 有      | ✅      |                           |
| **变量节点 (Variable)** |         |         |                           |
| - 设置/获取变量切换     | 有      | ✅      |                           |
| - 变量名称              | 有      | ✅      |                           |
| - 变量值配置            | 有      | ✅      |                           |
| **文本处理节点**        |         |         |                           |
| - 处理类型              | 有      | ✅      |                           |
| - 拼接文本列表          | 有      | ✅      |                           |
| - 连接符/分割符         | 有      | ✅      |                           |
| **文档提取节点**        |         |         |                           |
| - 文档变量选择          | 有      | ✅      |                           |
| - 输出参数配置          | 有      | ✅      |                           |
| **知识库节点**          |         |         |                           |
| - 知识库选择            | 有      | ✅      | Created 选择器            |
| - 搜索策略              | 有      | ✅      | Select/Slider             |
| - 最大召回数量          | 有      | ✅      | Slider                    |
| - 最小匹配度            | 有      | ✅      | Slider                    |
| **插件节点**            |         |         |                           |
| - 插件选择              | 有      | ✅      | 发布库选择器，透传入/出参 |
| - 参数配置              | 有      | ✅      | 入/出参透传，表单可改写   |
| **工作流节点**          |         |         |                           |
| - 工作流选择            | 有      | ✅      | 发布库选择器，透传入/出参 |
| - 参数映射              | 有      | ✅      | 入/出参透传，表单可改写   |
| **数据库节点**          |         |         |                           |
| - 数据表选择            | 有      | ✅      | 发布库选择器，透传字段    |
| - 操作类型              | 有      | ✅      | 表单配置                  |
| - 字段/条件配置         | 有      | ✅      | 入参/条件编辑             |

### 4.3 变量引用功能

| V1 功能 | V2 状态 | 备注 |
| --- | --- | --- |
| 变量引用选择器 | ✅ | VariableSelectorV2 |
| 上游节点变量列表 | ✅ | variableReferenceV2.ts |
| 嵌套属性展示（树形） | ✅ | TreeSelect |
| 数据类型过滤 | ✅ | filterType prop |
| 循环内部变量引用 | ✅ | innerPreviousNodes |
| 变量显示名称 | ✅ | 节点名.变量名 |
| 规则文档 | ✅ | [VARIABLE_REFERENCE_RULES.md](./VARIABLE_REFERENCE_RULES.md) |

---

## 五、工具栏功能

### 5.1 顶部工具栏

| V1 功能            | V2 状态 | 备注             |
| ------------------ | ------- | ---------------- |
| 返回按钮           | ✅      | HeaderV2         |
| 工作流名称显示     | ✅      |                  |
| 编辑工作流信息按钮 | ✅      |                  |
| 撤销按钮           | ✅      |                  |
| 重做按钮           | ✅      |                  |
| 保存按钮           | ✅      |                  |
| 发布按钮           | ✅      |                  |
| 版本历史按钮       | ✅      |                  |
| 保存状态指示       | ✅      | isDirty/isSaving |

### 5.2 底部控制面板

| V1 功能        | V2 状态 | 备注           |
| -------------- | ------- | -------------- |
| 缩放百分比显示 | ✅      | ControlPanelV2 |
| 放大按钮       | ✅      |                |
| 缩小按钮       | ✅      |                |
| 适应视图按钮   | ✅      |                |
| 添加节点按钮   | ✅      |                |
| 试运行按钮     | ✅      |                |

### 5.3 节点选择面板

| V1 功能       | V2 状态 | 备注        |
| ------------- | ------- | ----------- |
| 面板显示/隐藏 | ✅      |             |
| 节点分组显示  | ✅      | asideListV2 |
| 节点图标显示  | ✅      |             |
| 节点名称显示  | ✅      |             |
| 点击添加节点  | ✅      |             |
| 拖拽添加节点  | ✅      | onDragEnd   |

---

## 六、数据保存

| V1 功能        | V2 状态 | 备注               |
| -------------- | ------- | ------------------ |
| 手动保存       | ✅      | saveNow()          |
| 自动保存       | ❌      | 已禁用，待后端接口 |
| 保存成功提示   | ✅      | message.success    |
| 保存失败提示   | ✅      | message.error      |
| 保存失败重试   | ✅      | useWorkflowDataV2  |
| 未保存离开提示 | ✅      | beforeunload       |

---

## 七、撤销/重做

| V1 功能                      | V2 状态 | 备注            |
| ---------------------------- | ------- | --------------- |
| 撤销操作（按钮）             | ✅      | HeaderV2        |
| 重做操作（按钮）             | ✅      | HeaderV2        |
| 撤销快捷键（Ctrl+Z）         | ✅      | EventHandlersV2 |
| 重做快捷键（Ctrl+Shift+Z/Y） | ✅      | EventHandlersV2 |
| 撤销/重做按钮状态            | ✅      | canUndo/canRedo |
| 历史记录限制                 | ✅      | 最大 50 步      |

---

## 八、弹窗功能

### 8.1 试运行弹窗

| V1 功能        | V2 状态 | 备注           |
| -------------- | ------- | -------------- |
| 打开试运行弹窗 | ✅      | TestRunModalV2 |
| 输入参数表单   | ✅      |                |
| 执行试运行     | 🚧      | 待接口         |
| 运行状态显示   | ✅      |                |
| 运行结果展示   | ✅      |                |
| 停止运行       | ✅      |                |

**支持试运行的节点类型**（与 V1 `testRunList` 一致）：

| 节点类型           | V2 支持 | 说明          |
| ------------------ | ------- | ------------- |
| Start              | ✅      | 开始节点      |
| LLM                | ✅      | 大模型节点    |
| Plugin             | ✅      | 插件节点      |
| Code               | ✅      | 代码节点      |
| HTTPRequest        | ✅      | HTTP 请求节点 |
| TextProcessing     | ✅      | 文本处理节点  |
| Workflow           | ✅      | 工作流节点    |
| DocumentExtraction | ✅      | 文档提取节点  |
| Knowledge          | ✅      | 知识库节点    |
| TableSQL           | ✅      | 数据表 SQL    |
| TableDataQuery     | ✅      | 数据表查询    |
| TableDataUpdate    | ✅      | 数据表更新    |
| TableDataDelete    | ✅      | 数据表删除    |
| TableDataAdd       | ✅      | 数据表新增    |

### 8.2 发布弹窗

| V1 功能      | V2 状态 | 备注           |
| ------------ | ------- | -------------- |
| 打开发布弹窗 | ✅      | PublishModalV2 |
| 版本描述输入 | ✅      |                |
| 校验错误显示 | ✅      |                |
| 执行发布     | 🚧      | 待接口         |

### 8.3 其他弹窗

| V1 功能              | V2 状态 | 备注                     |
| -------------------- | ------- | ------------------------ |
| 编辑工作流信息弹窗   | ✅      | EditWorkflowModalV2      |
| 版本历史抽屉         | ✅      | VersionHistoryV2         |
| 创建组件弹窗         | ✅      | CreateComponentModalV2   |
| 端口点击节点选择弹窗 | ✅      | Modal + StencilContentV2 |

---

## 九、运行动画

| V1 功能      | V2 状态 | 备注               |
| ------------ | ------- | ------------------ |
| 节点运行高亮 | ✅      | nodeAnimationV2.ts |
| 运行状态图标 | ✅      | runningNode        |
| 错误节点标记 | ✅      | errorNode          |
| 完成节点高亮 | ✅      | highlightNode      |
| 连线流动动画 | ❌      |                    |

---

## 十、快捷键

| 快捷键           | V1 功能  | V2 状态 |
| ---------------- | -------- | ------- |
| Ctrl+Z           | 撤销     | ✅      |
| Ctrl+Y/Shift+Z   | 重做     | ✅      |
| Ctrl+S           | 保存     | ✅      |
| Delete/Backspace | 删除选中 | ✅      |
| Ctrl+C           | 复制节点 | ✅      |
| Ctrl+V           | 粘贴节点 | ✅      |
| Ctrl+A           | 全选     | ✅      |
| Escape           | 取消选择 | ✅      |
| 方向键           | 移动节点 | ✅      |
| Ctrl+=/-         | 缩放     | ✅      |
| Ctrl+0           | 重置缩放 | ✅      |

---

## 十一、异常处理

| V1 功能                         | V2 状态 | 备注                    |
| ------------------------------- | ------- | ----------------------- |
| 异常处理配置                    | ✅      | ExceptionHandleConfigV2 |
| 异常流程连线                    | ✅      | exception 端口组        |
| 超时设置                        | ✅      |                         |
| 重试配置                        | ✅      |                         |
| 异常处理类型切换时端口显示/隐藏 | ✅      | 端口联动更新            |
| 异常端口连线初始化无回折        | ✅      | sourcePort 格式对齐 V1  |

---

## 十二、前端校验

| V1 功能            | V2 状态 | 备注                        |
| ------------------ | ------- | --------------------------- |
| 工作流整体校验     | ✅      | workflowValidatorV2.ts      |
| 节点配置完整性校验 | ✅      | validateNodeConfig          |
| 连线关系校验       | ✅      | validateConnections         |
| 循环检测           | ✅      | detectCycle                 |
| 可达性检测         | ✅      | canReachEnd                 |
| 孤立节点检测       | ✅      |                             |
| 变量引用校验       | ✅      | validateInputArgsReferences |

---

## 已完成功能汇总

### 核心功能 ✅

- [x] 画布基础操作（平移、缩放、适应视图）
- [x] 节点选择（单选、多选、框选）
- [x] 节点添加（面板点击、面板拖拽、端口点击、边上插入）
- [x] 节点删除（快捷键、确认框）
- [x] 节点移动（拖拽、方向键）
- [x] 连线创建（拖拽、端口点击快捷添加）
- [x] 连线删除
- [x] 撤销/重做
- [x] 快捷键支持
- [x] 变量引用查找（前端实现）
- [x] 前端数据校验

### 节点配置 ✅

- [x] 开始节点、结束节点
- [x] LLM 大模型节点
- [x] 代码节点
- [x] HTTP 请求节点
- [x] 意图识别节点
- [x] 问答节点
- [x] 循环节点
- [x] 变量节点
- [x] 文本处理节点
- [x] 文档提取节点

### 弹窗功能 ✅

- [x] 试运行弹窗
- [x] 发布弹窗
- [x] 编辑工作流弹窗
- [x] 版本历史抽屉
- [x] 端口点击节点选择弹窗

---

## 待完成功能

### P0 - 高优先级

- [ ] 后端全量保存接口联调
- [ ] 试运行接口联调
- [ ] 发布接口联调
- [ ] 版本历史接口联调

### P1 - 中优先级

- [ ] 异常处理流程回归（exception 端口/配置链路）
- [ ] 自动保存恢复（走全量保存接口，待接口就绪）

### P2 - 低优先级

- [ ] 连线流动动画
- [ ] 技能组件选择优化

---

## 更新日志

### 2025-12-10 (更新)

- 修复初始化时特殊节点（意图识别、条件分支、问答选项）out port 连线回折问题
- 修复异常处理端口连线回折问题
- 边配置对齐 V1：初始化使用 orth 路由器，交互使用 manhattan 路由器
- sourcePort 格式对齐 V1：`${node.id}-${uuid}-out`、`${node.id}-exception-out`
- 添加特殊节点选项变更时的端口联动（删除端口时自动删除关联边）
- 添加异常处理配置变化时的端口联动
- 添加循环内节点更新时父节点大小调整
- 边连接完成后添加 toFront() 和 zIndex 设置（与 V1 保持一致）
- 新增连线与端口联动测试用例

### 2025-12-09 (更新)

- 右键菜单支持复制/粘贴/删除（Start/End 保护）
- 插件/工作流/MCP/知识库/数据库节点接入发布库选择器，透传入出参/字段
- 条件分支校验补充（比较符/参数必填规则）
- 变量引用规则文档链接补充

### 2025-12-08 (更新)

- 更新已完成功能状态
- 添加端口/边点击添加节点功能
- 完善自动连线逻辑
- 整理功能汇总清单

### 2025-12-08 (初始)

- 初始化回归测试清单
- 以 V1 功能为基准建立对照表
