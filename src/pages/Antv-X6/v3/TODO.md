# V3 工作流编辑器 TODO List

## 1. 离线模式支持

### 1.1 异常节点展示问题

- [ ] 异常节点展示时项目信息有问题
- [ ] 需要先进行前端缓存处理

### 1.2 循环节点初始化

- [ ] 新建循环节点时，内部默认的开始/结束节点没有正确展示出来
- [ ] 需要确保循环节点创建时自动添加并显示内部节点

### 1.3 离线状态提示

- [ ] 当前提示消息不友好
- [ ] 需要明确告知用户当前处于离线状态
- [ ] 添加离线状态指示器

---

## 2. 变量引用向上查找逻辑增强 ✅

### 问题描述

- 条件节点在新建后没有配置任何值（初始状态）时会被错误命中
- 编辑开始节点后，其他节点无法正确引用其变量
- 变量引用标签显示 `undefined - 变量名` 格式

### 根本原因

**ID 类型不一致**：画布节点数据的 `id` 可能是字符串（如 `"10206"`），而代码中使用数字比较（`10206`），导致 Map 查找失败。

### 修复方案

#### `utils/variableReferenceV3.ts`

| 函数                   | 修改内容                                        |
| ---------------------- | ----------------------------------------------- |
| `buildNodeMap()`       | 将 `node.id` 转换为数字：`Number(node.id)`      |
| `previousNodes.push()` | 确保 `id` 是数字类型：`id: Number(predNode.id)` |
| `flattenArgsToMap()`   | 使用数字 ID 生成 key                            |
| 过滤逻辑               | 简化为检查 `outputArgs.length === 0`            |

#### `indexV3.tsx`

| 修改内容 |
| --- |
| `getReference()` 从画布 `graphRef.getNodes()` 直接获取节点数据，确保使用最新编辑状态 |
| 边数据也从画布 `graphRef.getEdges()` 获取 |

#### `models/workflow.ts`

| 函数        | 修改内容                        |
| ----------- | ------------------------------- |
| `getName()` | 使用 `Number(_id)` 转换后再比较 |

---

## 3. 保存逻辑优化 ✅

### 核心思想

以当前画布上展示的节点与连线关系为优先。

### 修复方案

#### `services/workflowProxyV3.ts`

| 新增方法                    | 功能                   |
| --------------------------- | ---------------------- |
| `validateDataConsistency()` | 在保存前验证数据一致性 |

**验证内容**:

1. 检查所有边的 source/target 节点是否存在
2. 自动移除无效边
3. 检查 nextNodeIds 与画布边的一致性
4. 自动修复缺失或多余的 nextNodeIds

---

## 4. 循环节点内功能测试

### 4.1 变量聚合测试

- [ ] 在循环节点内部测试变量聚合节点的功能
- [ ] 验证分组配置是否正确保存和回显
- [ ] 验证输出展示是否正确显示嵌套子字段

### 4.2 变量引用查找逻辑测试

- [ ] 在循环节点内部测试变量引用向上查找逻辑
- [ ] 验证循环节点内部节点能否正确引用外部节点的变量
- [ ] 验证循环节点内部节点之间的变量引用是否正常

---

## 更新记录

| 日期       | 更新内容                        |
| ---------- | ------------------------------- |
| 2025-12-16 | 初始创建 TODO 列表              |
| 2025-12-16 | 完成 TODO 2 和 TODO 3 的实现    |
| 2025-12-16 | 修复变量引用 ID 类型不匹配问题  |
| 2025-12-17 | P0/P1 验证全部通过              |
| 2025-12-17 | 修复撤销/重做保存触发           |
| 2025-12-17 | 修复历史记录包含端口 hover 事件 |
| 2025-12-17 | 节点复制支持多次粘贴 + 累积偏移 |
| 2025-12-17 | 复制节点 ID 生成规则统一        |
| 2025-12-17 | 复制节点渲染 shape 修复         |

---

## ✅ V3 已达到可上线状态 (P0/P1 全部通过, P2 延期)
