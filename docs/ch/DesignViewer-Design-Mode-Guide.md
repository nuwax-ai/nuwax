# DesignViewer Design æ¨¡å¼å¼€å‘æŒ‡å—

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
  - [ç»„ä»¶ç»“æ„](#ç»„ä»¶ç»“æ„)
  - [æ•°æ®æµ](#æ•°æ®æµ)
  - [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
  - [Vite æ’ä»¶é¢„æ³¨å…¥](#vite-æ’ä»¶é¢„æ³¨å…¥)
  - [æ¶ˆæ¯é€šä¿¡](#æ¶ˆæ¯é€šä¿¡)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
  - [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
  - [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
  - [è¯¦ç»†æ­¥éª¤è¯´æ˜](#è¯¦ç»†æ­¥éª¤è¯´æ˜)
- [å·²å®ç°åŠŸèƒ½](#å·²å®ç°åŠŸèƒ½)
- [å¾…å®ç°åŠŸèƒ½](#å¾…å®ç°åŠŸèƒ½)
- [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)
- [å¼€å‘è§„èŒƒ](#å¼€å‘è§„èŒƒ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
  - [æ’ä»¶æœªå®‰è£…æˆ–é…ç½®é”™è¯¯](#0-æ’ä»¶æœªå®‰è£…æˆ–é…ç½®é”™è¯¯)
  - [æ ·å¼ä¸ç”Ÿæ•ˆ](#1-æ ·å¼ä¸ç”Ÿæ•ˆ)
  - [æ ·å¼å†²çª](#2-æ ·å¼å†²çª)
  - [å˜æ›´æœªä¿å­˜](#3-å˜æ›´æœªä¿å­˜)
  - [å…ƒç´ é€‰æ‹©å¤±è´¥](#4-å…ƒç´ é€‰æ‹©å¤±è´¥)
  - [æ€§èƒ½é—®é¢˜](#5-æ€§èƒ½é—®é¢˜)
- [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

## æ¦‚è¿°

DesignViewer æ˜¯ä¸€ä¸ªå¯è§†åŒ–è®¾è®¡ç¼–è¾‘å™¨ç»„ä»¶ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡ç›´è§‚çš„ UI é¢æ¿ç¼–è¾‘é¡µé¢å…ƒç´ çš„æ ·å¼å’Œå†…å®¹ã€‚å®ƒåŸºäº Tailwind CSS ç±»åç³»ç»Ÿï¼Œå®ç°äº†æ‰€è§å³æ‰€å¾—çš„è®¾è®¡ä½“éªŒã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å®æ—¶é¢„è§ˆ**ï¼šä¿®æ”¹æ ·å¼åç«‹å³åœ¨ iframe ä¸­çœ‹åˆ°æ•ˆæœ
- **Tailwind CSS é›†æˆ**ï¼šå®Œå…¨åŸºäº Tailwind CSS ç±»åç³»ç»Ÿ
- **åŒå‘åŒæ­¥**ï¼šæ”¯æŒä»æºä»£ç è§£ææ ·å¼ï¼Œä¹Ÿæ”¯æŒå°†ä¿®æ”¹å†™å›æºä»£ç 
- **å…ƒç´ å®šä½**ï¼šé€šè¿‡ sourceInfoï¼ˆæ–‡ä»¶è·¯å¾„ã€è¡Œå·ã€åˆ—å·ï¼‰ç²¾ç¡®å®šä½å…ƒç´ 
- **å˜æ›´è¿½è¸ª**ï¼šæ‰€æœ‰ä¿®æ”¹è®°å½•åœ¨ pendingChanges ä¸­ï¼Œæ”¯æŒæ‰¹é‡ä¿å­˜

### ä½¿ç”¨åœºæ™¯

- å¿«é€Ÿè°ƒæ•´é¡µé¢å…ƒç´ çš„æ ·å¼
- å¯è§†åŒ–ç¼–è¾‘ç»„ä»¶å±æ€§
- å®æ—¶é¢„è§ˆè®¾è®¡æ•ˆæœ
- æ‰¹é‡åº”ç”¨æ ·å¼ä¿®æ”¹

## æ¶æ„è®¾è®¡

### ç»„ä»¶ç»“æ„

```
DesignViewer/
â”œâ”€â”€ index.tsx                    # ä¸»ç»„ä»¶
â”œâ”€â”€ index.less                   # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ applyDesignChanges.ts        # åº”ç”¨è®¾è®¡æ›´æ”¹åˆ°æºä»£ç 
â”œâ”€â”€ messages.ts                  # æ¶ˆæ¯ç±»å‹å®šä¹‰
â”œâ”€â”€ design.images.constants.ts  # å›¾æ ‡å¸¸é‡
â””â”€â”€ utils/                       # å·¥å…·å‡½æ•°
    â”œâ”€â”€ tailwind-border.ts       # è¾¹æ¡†ç›¸å…³å·¥å…·
    â”œâ”€â”€ tailwind-color.ts        # é¢œè‰²ç›¸å…³å·¥å…·
    â”œâ”€â”€ tailwind-fontSize.ts     # å­—ä½“å¤§å°å·¥å…·
    â”œâ”€â”€ tailwind-fontWeight.ts   # å­—ä½“ç²—ç»†å·¥å…·
    â”œâ”€â”€ tailwind-letterSpacing.ts # å­—é—´è·å·¥å…·
    â”œâ”€â”€ tailwind-lineHeight.ts   # è¡Œé«˜å·¥å…·
    â”œâ”€â”€ tailwind-opacity.ts      # é€æ˜åº¦å·¥å…·
    â”œâ”€â”€ tailwind-radius.ts       # åœ†è§’å·¥å…·
    â”œâ”€â”€ tailwind-shadow.ts       # é˜´å½±å·¥å…·
    â”œâ”€â”€ tailwind-space.ts        # é—´è·å·¥å…·ï¼ˆpadding/marginï¼‰
    â””â”€â”€ tailwind-textAlign.tsx   # æ–‡æœ¬å¯¹é½å·¥å…·
```

### æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
  â†“
DesignViewer UI é¢æ¿
  â†“
æœ¬åœ°çŠ¶æ€æ›´æ–° (useState)
  â†“
toggleStyle() ç”Ÿæˆ Tailwind ç±»å
  â†“
postMessage å‘é€åˆ° iframe
  â†“
iframe å®æ—¶åº”ç”¨æ ·å¼
  â†“
è®°å½•åˆ° pendingChanges
  â†“
ç”¨æˆ·ä¿å­˜
  â†“
applyDesignChanges() åº”ç”¨åˆ°æºä»£ç 
```

### çŠ¶æ€ç®¡ç†

ä½¿ç”¨ UmiJS Model (`appDevDesign`) ç®¡ç†å…¨å±€çŠ¶æ€ï¼š

```typescript
interface AppDevDesignModel {
  // æ˜¯å¦å¼€å¯è®¾è®¡æ¨¡å¼
  iframeDesignMode: boolean;
  // iframe æ˜¯å¦åŠ è½½å®Œæ¯•
  isIframeLoaded: boolean;
  // é€‰ä¸­çš„å…ƒç´ ä¿¡æ¯
  selectedElement: ElementInfo | null;
  // å¾…å¤„ç†çš„å˜æ›´åˆ—è¡¨
  pendingChanges: Array<{
    type: 'style' | 'content';
    sourceInfo: SourceInfo;
    newValue: string;
    originalValue?: string;
  }>;
}
```

### Vite æ’ä»¶é¢„æ³¨å…¥

DesignViewer ä¾èµ– `@xagi/vite-plugin-design-mode` Vite æ’ä»¶æ¥å®ç°æºç æ˜ å°„åŠŸèƒ½ã€‚è¯¥æ’ä»¶åœ¨ç¼–è¯‘æ—¶å‘ DOM å…ƒç´ æ³¨å…¥æºç ä½ç½®ä¿¡æ¯ï¼ˆ`data-xagi-*` å±æ€§ï¼‰ï¼Œä½¿å¾— DesignViewer èƒ½å¤Ÿç²¾ç¡®å®šä½å…ƒç´ åœ¨æºä»£ç ä¸­çš„ä½ç½®ã€‚

#### æ’ä»¶ä½œç”¨

1. **æºç æ˜ å°„æ³¨å…¥**ï¼šåœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ Babel AST è½¬æ¢ JSX/TSX/JS æ–‡ä»¶ï¼Œå°†æºç ä½ç½®ä¿¡æ¯ä½œä¸ºç´§å‡‘çš„ `data-xagi-info` JSON å±æ€§æ³¨å…¥åˆ° DOM å…ƒç´ ï¼ˆå‡å°‘ DOM ä½“ç§¯ï¼‰
2. **å…ƒç´ æ ‡è¯†**ï¼šä¸ºæ¯ä¸ªå…ƒç´ ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆ`data-xagi-element-id`ï¼‰ï¼Œæ ¼å¼ä¸º `æ–‡ä»¶è·¯å¾„:è¡Œå·:åˆ—å·_æ ‡ç­¾å#ID`ï¼ˆå¦‚æœæœ‰ id å±æ€§ï¼‰æˆ– `æ–‡ä»¶è·¯å¾„:è¡Œå·:åˆ—å·_æ ‡ç­¾å`ï¼ˆå¦‚æœæ²¡æœ‰ id å±æ€§ï¼‰ï¼Œç”¨äºåˆ—è¡¨é¡¹åŒæ­¥å’Œå…ƒç´ è¯†åˆ«
3. **é™æ€å†…å®¹æ£€æµ‹**ï¼šæ™ºèƒ½è¯†åˆ«çº¯é™æ€æ–‡æœ¬ï¼ˆæ— å˜é‡ã€è¡¨è¾¾å¼æˆ–å­å…ƒç´ ï¼‰ï¼Œåªæœ‰é™æ€å†…å®¹æ‰èƒ½ç›´æ¥ç¼–è¾‘ï¼ˆæ ‡è®°ä¸º `data-xagi-static-content="true"`ï¼‰
4. **åˆ—è¡¨é¡¹åŒæ­¥**ï¼šç¼–è¾‘åˆ—è¡¨é¡¹æ—¶è‡ªåŠ¨åŒæ­¥æ‰€æœ‰ç›¸å…³å®ä¾‹ï¼ˆå†…å®¹æˆ–æ ·å¼ï¼‰ï¼Œä½¿ç”¨ `element-id` è¯†åˆ«ç›¸å…³åˆ—è¡¨é¡¹
5. **ç»„ä»¶è¯†åˆ«**ï¼šè¯†åˆ«ç»„ä»¶åç§°ã€å¯¼å…¥è·¯å¾„ï¼ŒåŒºåˆ†ç»„ä»¶ä½¿ç”¨ä½ç½®å’Œå®šä¹‰ä½ç½®ï¼Œè¯†åˆ« UI ç»„ä»¶ï¼ˆcomponents/ui ç›®å½•ä¸‹çš„ç»„ä»¶ï¼‰
6. **API ç«¯ç‚¹**ï¼šæä¾›æºç è·å–å’Œä¿®æ”¹çš„ API ç«¯ç‚¹ï¼Œæ”¯æŒå®æ—¶ç¼–è¾‘å’Œæ‰¹é‡æ›´æ–°
7. **åŒå‡»ç¼–è¾‘**ï¼šåŒå‡»é™æ€æ–‡æœ¬å…ƒç´ å³å¯è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå®æ—¶é¢„è§ˆå¹¶è‡ªåŠ¨ä¿å­˜åˆ°æºç 

#### å®‰è£…æµç¨‹

**åœ¨åç«¯å¯åŠ¨é¡¹ç›®å¼€å‘æœåŠ¡å‰ï¼Œéœ€è¦å…ˆå®‰è£…æ’ä»¶ï¼š**

```bash
# 1. å®‰è£… Vite æ’ä»¶ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰
pnpm dlx @xagi/vite-plugin-design-mode@latest install

# 2. å®‰è£…é¡¹ç›®ä¾èµ–
pnpm install

# 3. å¯åŠ¨å¼€å‘æœåŠ¡
pnpm dev
```

**å®‰è£…å‘½ä»¤è¯´æ˜ï¼š**

- `pnpm dlx @xagi/vite-plugin-design-mode@latest install` ä¼šè‡ªåŠ¨ï¼š
  - åœ¨ `package.json` çš„ `devDependencies` ä¸­æ·»åŠ æ’ä»¶ä¾èµ–
  - åœ¨ `vite.config.ts/js/mjs` ä¸­æ·»åŠ æ’ä»¶é…ç½®
  - ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ å‚

**é»˜è®¤é…ç½®ï¼š**

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import appdevDesignMode from '@xagi/vite-plugin-design-mode';

export default defineConfig({
  plugins: [
    react(),
    appdevDesignMode(), // ä½¿ç”¨é»˜è®¤é…ç½®
  ],
});
```

**é»˜è®¤é…ç½®é¡¹ï¼š**

- `enabled: true` - å¯ç”¨æ’ä»¶
- `enableInProduction: false` - ä»…åœ¨å¼€å‘ç¯å¢ƒç”Ÿæ•ˆ
- `verbose: true` - å¯ç”¨è¯¦ç»†æ—¥å¿—
- `attributePrefix: 'data-xagi'` - æºç æ˜ å°„å±æ€§çš„å‰ç¼€
- `include: ['src/**/*.{ts,js,tsx,jsx}']` - å¤„ç† src ç›®å½•ä¸‹çš„æ–‡ä»¶
- `exclude: ['node_modules', 'dist']` - æ’é™¤æŒ‡å®šç›®å½•

#### ç”Ÿæˆçš„å±æ€§

æ’ä»¶å¤„ç†çš„å…ƒç´ å°†å…·æœ‰ä»¥ä¸‹å±æ€§ï¼ˆé»˜è®¤å‰ç¼€ä¸º `data-xagi`ï¼Œå¯é€šè¿‡ `attributePrefix` é…ç½®é¡¹è‡ªå®šä¹‰ï¼‰ï¼š

**æ ¸å¿ƒå±æ€§ï¼ˆå®é™…æ³¨å…¥ï¼‰ï¼š**

- **`{prefix}-info`**: åŒ…å«å®Œæ•´æºç æ˜ å°„ä¿¡æ¯çš„ JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

  - `fileName`: æºç æ–‡ä»¶è·¯å¾„
  - `lineNumber`: æºç è¡Œå·
  - `columnNumber`: æºç åˆ—å·
  - `elementType`: å…ƒç´ ç±»å‹ï¼ˆæ ‡ç­¾åï¼‰
  - `componentName`: ç»„ä»¶åç§°ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
  - `functionName`: å‡½æ•°åç§°ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
  - `elementId`: å”¯ä¸€å…ƒç´ æ ‡è¯†ç¬¦
  - `importPath`: ç»„ä»¶å¯¼å…¥è·¯å¾„ï¼ˆç”¨äºåŒºåˆ†ç»„ä»¶ä½¿ç”¨ä½ç½®å’Œå®šä¹‰ä½ç½®ï¼‰
  - `isUIComponent`: æ˜¯å¦æ˜¯ UI ç»„ä»¶ï¼ˆcomponents/ui ç›®å½•ä¸‹çš„ç»„ä»¶ï¼‰

- **`{prefix}-element-id`**: å”¯ä¸€å…ƒç´ æ ‡è¯†ç¬¦ï¼Œæ ¼å¼ä¸º `æ–‡ä»¶è·¯å¾„:è¡Œå·:åˆ—å·_æ ‡ç­¾å#ID`ï¼ˆå¦‚æœæœ‰ id å±æ€§ï¼‰æˆ– `æ–‡ä»¶è·¯å¾„:è¡Œå·:åˆ—å·_æ ‡ç­¾å`ï¼ˆå¦‚æœæ²¡æœ‰ id å±æ€§ï¼‰ã€‚ç”¨äºåˆ—è¡¨é¡¹åŒæ­¥å’Œå…ƒç´ è¯†åˆ«ã€‚

- **`{prefix}-position`**: ä½ç½®ä¿¡æ¯ï¼Œæ ¼å¼ä¸º `è¡Œå·:åˆ—å·`ï¼ˆç®€åŒ–ç‰ˆä½ç½®ä¿¡æ¯ï¼‰

- **`{prefix}-static-content`**: æ ‡è®°å…ƒç´ æ˜¯å¦åŒ…å«çº¯é™æ€å†…å®¹ï¼ˆå€¼ä¸º `'true'`ï¼‰ï¼Œç”¨äºåˆ¤æ–­å…ƒç´ æ˜¯å¦å¯ä»¥ç›´æ¥ç¼–è¾‘ã€‚åªæœ‰åŒ…å«çº¯é™æ€æ–‡æœ¬ï¼ˆæ— å˜é‡ã€è¡¨è¾¾å¼æˆ–å­å…ƒç´ ï¼‰çš„å…ƒç´ æ‰ä¼šè¢«æ ‡è®°ã€‚

- **`{prefix}-static-class`**: æ ‡è®° className æ˜¯å¦ä¸ºçº¯é™æ€å­—ç¬¦ä¸²ï¼ˆå€¼ä¸º `'true'`ï¼‰ï¼Œç”¨äºåˆ¤æ–­æ ·å¼æ˜¯å¦å¯ä»¥ç›´æ¥ç¼–è¾‘ã€‚

- **`{prefix}-children-source`**: å­å…ƒç´ çš„æºç ä½ç½®ä¿¡æ¯ï¼Œæ ¼å¼ä¸º `æ–‡ä»¶è·¯å¾„:è¡Œå·:åˆ—å·`ï¼ˆç”¨äºé€ä¼ ç»„ä»¶è¿½è¸ªé™æ€æ–‡æœ¬å­å…ƒç´ çš„æ¥æºä½ç½®ï¼‰

**ä¼˜åŒ–è¯´æ˜ï¼š**

ä¸ºäº†å‡å°‘ DOM ä½“ç§¯ï¼Œæ’ä»¶é‡‡ç”¨äº†ç´§å‡‘çš„å±æ€§ç­–ç•¥ï¼š

- **æ‰€æœ‰ä¸»è¦ä¿¡æ¯éƒ½åŒ…å«åœ¨ `{prefix}-info` ä¸­**ï¼Œä¸å†å•ç‹¬æ³¨å…¥ `{prefix}-file`ã€`{prefix}-line`ã€`{prefix}-column`ã€`{prefix}-component`ã€`{prefix}-function`ã€`{prefix}-import` ç­‰å±æ€§
- è¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡è§£æ `{prefix}-info` JSON å­—ç¬¦ä¸²è·å–

#### å·¥ä½œåŸç†

1. **ç¼–è¯‘æ—¶è½¬æ¢**ï¼šæ’ä»¶åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ Babel AST è½¬æ¢ JSX/TSX/JS æ–‡ä»¶
2. **æŠ½è±¡è¯­æ³•æ ‘åˆ†æ**ï¼šåˆ†æ AST è¯†åˆ« React ç»„ä»¶å’Œ DOM å…ƒç´ 
   - è¿½è¸ª ImportDeclaration ä»¥è§£æç»„ä»¶å®šä¹‰å’Œå¯¼å…¥è·¯å¾„
   - é™æ€åˆ†æç¡®å®šå†…å®¹æ˜¯å¦ä¸ºçº¯é™æ€æ–‡æœ¬ï¼ˆ`isStaticContent`ï¼‰
   - è¯†åˆ« UI ç»„ä»¶ï¼ˆcomponents/ui ç›®å½•ä¸‹çš„ç»„ä»¶ï¼‰
3. **æºç æ˜ å°„æ•°æ®æ³¨å…¥**ï¼šå°†æºç ä½ç½®ä¿¡æ¯ä½œä¸ºç´§å‡‘çš„ `data-*` å±æ€§ï¼ˆé»˜è®¤å‰ç¼€ `data-xagi`ï¼‰æ³¨å…¥åˆ° DOM å…ƒç´ 
   - ä¸»è¦ä¿¡æ¯å­˜å‚¨åœ¨ `data-xagi-info` JSON å±æ€§ä¸­ï¼ˆå‡å°‘ DOM ä½“ç§¯ï¼‰
   - æ·»åŠ  `data-xagi-element-id` ç”¨äºå”¯ä¸€æ ‡è¯†å’Œåˆ—è¡¨é¡¹åŒæ­¥
   - æ·»åŠ  `data-xagi-static-content` æ ‡è®°å¯ç¼–è¾‘çš„é™æ€å†…å®¹
4. **è™šæ‹Ÿæ¨¡å—åŠ è½½**ï¼šé€šè¿‡ Vite è™šæ‹Ÿæ¨¡å—æœºåˆ¶åŠ¨æ€åŠ è½½å®¢æˆ·ç«¯ä»£ç 
5. **è¿è¡Œæ—¶é€šä¿¡**ï¼šè®¾è®¡æ¨¡å¼ UI é€šè¿‡æ¡¥æ¥ç³»ç»Ÿä¸å¤–éƒ¨å·¥å…·é€šä¿¡ï¼Œæ”¯æŒå®æ—¶ç¼–è¾‘
   - æ”¯æŒ iframe æ¨¡å¼ï¼Œé€šè¿‡ `postMessage` ä¸çˆ¶çª—å£é€šä¿¡
   - æ”¯æŒå…ƒç´ é€‰æ‹©ã€æ ·å¼æ›´æ–°ã€å†…å®¹æ›´æ–°ç­‰æ¶ˆæ¯ç±»å‹
6. **æºç æŒä¹…åŒ–**ï¼šä¿®æ”¹çš„æ ·å¼å’Œå†…å®¹é€šè¿‡ API ç«¯ç‚¹å®æ—¶å†™å…¥æºç æ–‡ä»¶
   - ä½¿ç”¨æ™ºèƒ½æ–‡æœ¬æ›¿æ¢ç®—æ³•ï¼ŒåŸºäºè¡Œ/åˆ—ä¿¡æ¯å®‰å…¨ä¿®æ”¹æºç 
   - æ”¯æŒæ ·å¼ï¼ˆclassNameï¼‰ã€å†…å®¹ï¼ˆinnerTextï¼‰ã€å±æ€§æ›´æ–°
7. **åˆ—è¡¨é¡¹åŒæ­¥**ï¼šä½¿ç”¨ `element-id` è¯†åˆ«ç›¸å…³åˆ—è¡¨é¡¹ï¼Œç¼–è¾‘ä¸€ä¸ªå®ä¾‹è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰å®ä¾‹
8. **æ‰¹é‡æ›´æ–°**ï¼šæ”¯æŒæ‰¹é‡æ›´æ–°å¤šä¸ªå…ƒç´ ï¼Œé€šè¿‡é˜²æŠ–æœºåˆ¶ä¼˜åŒ–æ€§èƒ½
9. **å¤‡ä»½ä¸å†å²**ï¼šå¯é€‰å¯ç”¨å¤‡ä»½å’Œå†å²è®°å½•åŠŸèƒ½ï¼Œæ”¯æŒæ’¤é”€æ“ä½œ

> ğŸ“– **è¯¦ç»†è¯´æ˜**: å…³äºæ’ä»¶çš„å®Œæ•´æ–‡æ¡£å’Œé…ç½®é€‰é¡¹ï¼Œè¯·å‚è€ƒ [Vite Plugin AppDev Design Mode README](https://github.com/dongdada29/vite-plugin-appdev-design-mode/blob/main/README.md)ã€‚

### æ¶ˆæ¯é€šä¿¡

DesignViewer é€šè¿‡ `postMessage` API ä¸ iframe é€šä¿¡ï¼š

**iframe â†’ Parent (DesignViewer)**

- `ELEMENT_SELECTED`: å…ƒç´ è¢«é€‰ä¸­
- `ELEMENT_DESELECTED`: å…ƒç´ å–æ¶ˆé€‰ä¸­
- `CONTENT_UPDATED`: å†…å®¹æ›´æ–°
- `STYLE_UPDATED`: æ ·å¼æ›´æ–°
- `DESIGN_MODE_CHANGED`: è®¾è®¡æ¨¡å¼çŠ¶æ€å˜åŒ–

**Parent â†’ iframe**

- `TOGGLE_DESIGN_MODE`: åˆ‡æ¢è®¾è®¡æ¨¡å¼
- `UPDATE_STYLE`: æ›´æ–°æ ·å¼
- `UPDATE_CONTENT`: æ›´æ–°å†…å®¹
- `BATCH_UPDATE`: æ‰¹é‡æ›´æ–°

## æ ¸å¿ƒåŠŸèƒ½

### 1. å…ƒç´ é€‰æ‹©ä¸è§£æ

å½“ç”¨æˆ·åœ¨ iframe ä¸­ç‚¹å‡»å…ƒç´ æ—¶ï¼š

1. iframe å‘é€ `ELEMENT_SELECTED` æ¶ˆæ¯
2. DesignViewer æ¥æ”¶æ¶ˆæ¯å¹¶è§£æ `ElementInfo`
3. ä» `className` ä¸­è§£æ Tailwind CSS ç±»å
4. æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œæ˜¾ç¤ºåœ¨ UI é¢æ¿ä¸­

```typescript
const parseTailwindClassesAndUpdateStates = (className: string) => {
  // 1. é‡ç½®æœ¬åœ°çŠ¶æ€
  resetLocalStates();

  // 2. æ‹†åˆ†ç±»å
  const classes = className.split(/\s+/).filter((c) => c.trim());

  // 3. éå†è§£ææ¯ä¸ªç±»å
  classes.forEach((cls) => {
    // è§£æ padding: p-4, px-8, py-2, pt-1 ç­‰
    // è§£æ margin: m-4, mx-8, my-2, mt-1 ç­‰
    // è§£æé¢œè‰²: text-red-500, bg-blue-600 ç­‰
    // è§£æå­—ä½“: font-bold, text-lg, leading-6 ç­‰
    // ... æ›´å¤šæ ·å¼è§£æ
  });

  // 4. æ›´æ–°æœ¬åœ°çŠ¶æ€
  updateLocalStatesFromStyles(styles);
};
```

### 2. æ ·å¼åˆ‡æ¢æœºåˆ¶

æ ¸å¿ƒæ–¹æ³• `toggleStyle()` è´Ÿè´£ç®¡ç† Tailwind ç±»åçš„æ·»åŠ å’Œç§»é™¤ï¼š

```typescript
const toggleStyle = (
  newStyle: string,
  regex: RegExp,
  attribute?: toggleStyleAttributeType,
) => {
  // 1. è·å–å½“å‰ç±»ååˆ—è¡¨
  const currentClasses = editingClass.split(' ').filter((c) => c.trim());

  // 2. æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ‰åŒç±»æ ·å¼
  const filterCurrentClasses = currentClasses.filter((c) => {
    // ç‰¹æ®Šå¤„ç†ï¼šé¿å…è¯¯åˆ å…¶ä»–æ ·å¼ï¼ˆå¦‚ text-center å’Œ text-lgï¼‰
    if (attribute === 'fontSize') {
      // ä¿ç•™ text-center ç­‰éå­—ä½“å¤§å°çš„ text- ç±»å
      return !regex.test(c) || c === 'text-center';
    }
    return !regex.test(c);
  });

  // 3. æ·»åŠ æ–°æ ·å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (newStyle) {
    filterCurrentClasses.push(newStyle);
  }

  // 4. æ›´æ–° editingClass å¹¶å‘é€åˆ° iframe
  const finalClasses = filterCurrentClasses.join(' ');
  setEditingClass(finalClasses);
  handleStyleUpdate(finalClasses);
};
```

### 3. å®æ—¶é¢„è§ˆ

æ ·å¼ä¿®æ”¹é€šè¿‡ `postMessage` å®æ—¶å‘é€åˆ° iframeï¼š

```typescript
const handleStyleUpdate = (newClass: string) => {
  // 1. è®°å½•åˆ° pendingChanges
  upsertPendingChange('style', newClass);

  // 2. å‘é€åˆ° iframe
  const iframe = document.querySelector('iframe');
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage(
      {
        type: 'UPDATE_STYLE',
        payload: {
          sourceInfo: selectedElement?.sourceInfo,
          newClass,
          persist: false, // ä¸æŒä¹…åŒ–ï¼Œä»…é¢„è§ˆ
        },
        timestamp: Date.now(),
      },
      '*',
    );
  }
};
```

### 4. å˜æ›´åº”ç”¨

ç”¨æˆ·ä¿å­˜æ—¶ï¼Œé€šè¿‡ `applyDesignChanges()` å°†ä¿®æ”¹åº”ç”¨åˆ°æºä»£ç ï¼š

```typescript
export const applyDesignChanges = async (
  fileContent: string,
  changes: Array<{
    type: 'style' | 'content';
    sourceInfo: SourceInfo;
    newValue: string;
    originalValue?: string;
  }>,
): Promise<string> => {
  // 1. æŒ‰ä½ç½®ä»åå¾€å‰æ’åºï¼Œé˜²æ­¢ç´¢å¼•åç§»
  const sortedChanges = [...changes].sort((a, b) => {
    if (a.sourceInfo.lineNumber !== b.sourceInfo.lineNumber) {
      return b.sourceInfo.lineNumber - a.sourceInfo.lineNumber;
    }
    return b.sourceInfo.columnNumber - a.sourceInfo.columnNumber;
  });

  // 2. åº”ç”¨æ¯ä¸ªä¿®æ”¹
  for (const change of sortedChanges) {
    updatedContent = await smartReplaceInSource(updatedContent, {
      lineNumber: change.sourceInfo.lineNumber,
      columnNumber: change.sourceInfo.columnNumber,
      newValue: change.newValue,
      originalValue: change.originalValue,
      type: change.type,
      tagName: change.sourceInfo.elementType,
    });
  }

  return updatedContent;
};
```

## å·¥ä½œæµç¨‹

### ç¯å¢ƒå‡†å¤‡

åœ¨ä½¿ç”¨ DesignViewer ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿é¡¹ç›®å·²å®‰è£…å¹¶é…ç½®äº† `@xagi/vite-plugin-design-mode` æ’ä»¶ã€‚

**å®‰è£…æ­¥éª¤ï¼š**

```bash
# 1. å®‰è£… Vite æ’ä»¶ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰
pnpm dlx @xagi/vite-plugin-design-mode@latest install

# 2. å®‰è£…é¡¹ç›®ä¾èµ–
pnpm install

# 3. å¯åŠ¨å¼€å‘æœåŠ¡
pnpm dev
```

> âš ï¸ **é‡è¦æç¤º**: æ’ä»¶å¿…é¡»åœ¨å¯åŠ¨å¼€å‘æœåŠ¡ä¹‹å‰å®‰è£…ã€‚å¦‚æœé¡¹ç›®å·²ç»åœ¨è¿è¡Œï¼Œéœ€è¦å…ˆåœæ­¢æœåŠ¡ï¼Œå®‰è£…æ’ä»¶åå†é‡æ–°å¯åŠ¨ã€‚

**éªŒè¯å®‰è£…ï¼š**

å®‰è£…å®Œæˆåï¼Œæ£€æŸ¥ `vite.config.ts` ä¸­æ˜¯å¦å·²è‡ªåŠ¨æ·»åŠ æ’ä»¶é…ç½®ï¼š

```typescript
import appdevDesignMode from '@xagi/vite-plugin-design-mode';

export default defineConfig({
  plugins: [
    react(),
    appdevDesignMode(), // æ’ä»¶å·²è‡ªåŠ¨é…ç½®
  ],
});
```

### å®Œæ•´å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Preview as Previewç»„ä»¶
    participant Iframe as iframe
    participant DesignViewer as DesignViewer
    participant Model as appDevDesign Model
    participant Source as æºä»£ç 

    User->>Preview: ç‚¹å‡»"è®¾è®¡æ¨¡å¼"æŒ‰é’®
    Preview->>Model: setIframeDesignMode(true)
    Model->>Iframe: postMessage(TOGGLE_DESIGN_MODE)
    Iframe->>Iframe: å¯ç”¨å…ƒç´ é€‰æ‹©åŠŸèƒ½

    User->>Iframe: ç‚¹å‡»é¡µé¢å…ƒç´ 
    Iframe->>DesignViewer: postMessage(ELEMENT_SELECTED)
    DesignViewer->>DesignViewer: è§£æ className
    DesignViewer->>DesignViewer: æ›´æ–°æœ¬åœ°çŠ¶æ€
    DesignViewer->>User: æ˜¾ç¤ºæ ·å¼é¢æ¿

    User->>DesignViewer: ä¿®æ”¹æ ·å¼ï¼ˆå¦‚é¢œè‰²ï¼‰
    DesignViewer->>DesignViewer: toggleStyle()
    DesignViewer->>Iframe: postMessage(UPDATE_STYLE)
    Iframe->>Iframe: å®æ—¶åº”ç”¨æ ·å¼
    DesignViewer->>Model: upsertPendingChange()

    User->>Preview: ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
    Preview->>DesignViewer: applyDesignChanges()
    DesignViewer->>Source: å†™å…¥ä¿®æ”¹åˆ°æºä»£ç 
    DesignViewer->>Model: setPendingChanges([])
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### 1. å¯ç”¨è®¾è®¡æ¨¡å¼

```typescript
// ç”¨æˆ·ç‚¹å‡»"è®¾è®¡æ¨¡å¼"æŒ‰é’®
const handleToggleDesignMode = () => {
  setIframeDesignMode(true);

  // å‘é€æ¶ˆæ¯åˆ° iframe
  const iframe = document.querySelector('iframe');
  if (iframe?.contentWindow) {
    iframe.contentWindow.postMessage(
      {
        type: 'TOGGLE_DESIGN_MODE',
        enabled: true,
        timestamp: Date.now(),
      },
      '*',
    );
  }
};
```

#### 2. é€‰æ‹©å…ƒç´ 

```typescript
// iframe ä¸­å…ƒç´ è¢«ç‚¹å‡»
window.addEventListener('click', (e) => {
  const element = e.target;
  const sourceInfo = getSourceInfo(element); // ä» data-* å±æ€§è·å–

  window.parent.postMessage(
    {
      type: 'ELEMENT_SELECTED',
      payload: {
        elementInfo: {
          tagName: element.tagName,
          className: element.className,
          textContent: element.textContent,
          isStaticText: isStaticTextElement(element),
          sourceInfo,
        },
      },
      timestamp: Date.now(),
    },
    '*',
  );
});
```

#### 3. è§£ææ ·å¼

```typescript
// DesignViewer æ¥æ”¶æ¶ˆæ¯å¹¶è§£æ
useEffect(() => {
  const handleMessage = (event: MessageEvent) => {
    if (event.data.type === 'ELEMENT_SELECTED') {
      const { elementInfo } = event.data.payload;
      setSelectedElement(elementInfo);

      // è§£æ Tailwind ç±»å
      if (elementInfo.className) {
        parseTailwindClassesAndUpdateStates(elementInfo.className);
      }
    }
  };

  window.addEventListener('message', handleMessage);
  return () => window.removeEventListener('message', handleMessage);
}, []);
```

#### 4. ä¿®æ”¹æ ·å¼

```typescript
// ç”¨æˆ·ä¿®æ”¹é¢œè‰²
const handleColorChange = (color: string) => {
  setLocalColor(color);

  // åˆ‡æ¢æ ·å¼ç±»å
  if (color === 'Default') {
    toggleStyle('', getColorClassRegexp('text'));
  } else {
    const colorClass = `text-${color}`;
    toggleStyle(colorClass, getColorClassRegexp('text'));
  }
};
```

#### 5. ä¿å­˜ä¿®æ”¹

```typescript
// åº”ç”¨æ‰€æœ‰å¾…å¤„ç†çš„ä¿®æ”¹
const handleSave = async () => {
  const fileContent = await getFileContent(filePath);
  const updatedContent = await applyDesignChanges(fileContent, pendingChanges);
  await saveFileContent(filePath, updatedContent);
  setPendingChanges([]);
};
```

## å·²å®ç°åŠŸèƒ½

### 1. æ–‡æœ¬å†…å®¹ç¼–è¾‘ âœ…

- **åŠŸèƒ½**ï¼šç¼–è¾‘é™æ€æ–‡æœ¬å…ƒç´ çš„å†…å®¹
- **å®ç°**ï¼šé€šè¿‡ `Input.TextArea` ç»„ä»¶ç¼–è¾‘ï¼Œå®æ—¶åŒæ­¥åˆ° iframe
- **é™åˆ¶**ï¼šä»…æ”¯æŒ `isStaticText === true` çš„å…ƒç´ ï¼ˆå³æ ‡è®°äº† `data-xagi-static-content="true"` çš„å…ƒç´ ï¼‰
- **æ’ä»¶æ”¯æŒ**ï¼šæ’ä»¶è¿˜æ”¯æŒåŒå‡»ç¼–è¾‘åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨ iframe ä¸­åŒå‡»é™æ€æ–‡æœ¬å…ƒç´ è¿›å…¥ç¼–è¾‘æ¨¡å¼
- **åˆ—è¡¨é¡¹åŒæ­¥**ï¼šå½“ç¼–è¾‘åˆ—è¡¨é¡¹æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨åŒæ­¥æ‰€æœ‰ç›¸å…³å®ä¾‹ï¼ˆé€šè¿‡ `data-xagi-element-id` è¯†åˆ«ï¼‰

```typescript
{
  selectedElement?.isStaticText && (
    <div className={cx(styles.propertySection)}>
      <div className={cx(styles.propertyLabel)}>æ–‡æœ¬å†…å®¹</div>
      <Input.TextArea
        value={localTextContent}
        onChange={(e) => handleTextContentChange(e.target.value)}
        autoSize={{ minRows: 3, maxRows: 4 }}
      />
    </div>
  );
}
```

### 2. å­—ä½“æ ·å¼ âœ…

#### 2.1 å­—ä½“ç²—ç»† (Font Weight)

- **é€‰é¡¹**ï¼šThin, Extra Light, Light, Regular, Medium, Semi Bold, Bold, Extra Bold, Black
- **ç±»åæ˜ å°„**ï¼š`font-thin`, `font-extralight`, `font-light`, `font-normal`, `font-medium`, `font-semibold`, `font-bold`, `font-extrabold`, `font-black`

#### 2.2 å­—ä½“å¤§å° (Font Size)

- **é€‰é¡¹**ï¼šxs, sm, base, lg, xl, 2xl, 3xl, 4xl, 5xl, 6xl, 7xl, 8xl, 9xl
- **ç±»åæ˜ å°„**ï¼š`text-xs`, `text-sm`, `text-base`, `text-lg`, `text-xl`, `text-2xl`, ç­‰

#### 2.3 è¡Œé«˜ (Line Height)

- **é€‰é¡¹**ï¼šåŸºäº Tailwind é»˜è®¤è¡Œé«˜é…ç½®
- **ç±»åæ˜ å°„**ï¼š`leading-none`, `leading-tight`, `leading-snug`, `leading-normal`, `leading-relaxed`, `leading-loose`, ç­‰

#### 2.4 å­—é—´è· (Letter Spacing)

- **é€‰é¡¹**ï¼šNone, Tighter, Tight, Normal, Wide, Wider, Widest
- **ç±»åæ˜ å°„**ï¼š`tracking-tighter`, `tracking-tight`, `tracking-normal`, `tracking-wide`, `tracking-wider`, `tracking-widest`

#### 2.5 æ–‡æœ¬å¯¹é½ (Text Align)

- **é€‰é¡¹**ï¼šLeft, Center, Right, Justify, Reset
- **ç±»åæ˜ å°„**ï¼š`text-left`, `text-center`, `text-right`, `text-justify`

### 3. é¢œè‰² âœ…

#### 3.1 æ–‡å­—é¢œè‰²

- **æ”¯æŒ**ï¼šæ‰€æœ‰ Tailwind é¢œè‰²å’Œè‰²é˜¶ï¼ˆ50-950ï¼‰
- **ç‰¹æ®Šå€¼**ï¼šDefault, transparent, black, white
- **ç±»åæ ¼å¼**ï¼š`text-{color}-{shade}`ï¼Œå¦‚ `text-red-500`

#### 3.2 èƒŒæ™¯é¢œè‰²

- **æ”¯æŒ**ï¼šæ‰€æœ‰ Tailwind é¢œè‰²å’Œè‰²é˜¶ï¼ˆ50-950ï¼‰
- **ç‰¹æ®Šå€¼**ï¼šDefault, transparent, black, white
- **ç±»åæ ¼å¼**ï¼š`bg-{color}-{shade}`ï¼Œå¦‚ `bg-blue-600`

### 4. å¸ƒå±€ âœ…

#### 4.1 å¤–è¾¹è· (Margin)

- **åŠŸèƒ½**ï¼šæ”¯æŒå››è¾¹ç‹¬ç«‹è®¾ç½®
- **æ¨¡å¼**ï¼š
  - **é”å®šæ¨¡å¼**ï¼šç»Ÿä¸€è®¾ç½®æ‰€æœ‰è¾¹ï¼ˆ`m-{value}`ï¼‰
  - **è§£é”æ¨¡å¼**ï¼š
    - **æŠ˜å **ï¼šä¸Šä¸‹ï¼ˆ`my-{value}`ï¼‰å’Œå·¦å³ï¼ˆ`mx-{value}`ï¼‰
    - **å±•å¼€**ï¼šå››è¾¹ç‹¬ç«‹ï¼ˆ`mt-{value}`, `mr-{value}`, `mb-{value}`, `ml-{value}`ï¼‰
- **é€‰é¡¹**ï¼šåŸºäº Tailwind spacing é…ç½®ï¼ˆ0, px, 0.5, 1, 1.5, 2, ..., 96, autoï¼‰

#### 4.2 å†…è¾¹è· (Padding)

- **åŠŸèƒ½**ï¼šæ”¯æŒå››è¾¹ç‹¬ç«‹è®¾ç½®
- **æ¨¡å¼**ï¼šåŒå¤–è¾¹è·
- **é€‰é¡¹**ï¼šåŸºäº Tailwind spacing é…ç½®ï¼ˆä¸åŒ…å« autoï¼‰

### 5. è¾¹æ¡† âœ…

#### 5.1 è¾¹æ¡†é¢œè‰²

- **æ”¯æŒ**ï¼šæ‰€æœ‰ Tailwind é¢œè‰²å’Œè‰²é˜¶
- **ç±»åæ ¼å¼**ï¼š`border-{color}-{shade}`

#### 5.2 è¾¹æ¡†æ ·å¼

- **é€‰é¡¹**ï¼šNone, Solid, Dashed, Dotted, Double
- **ç±»åæ˜ å°„**ï¼š`border-none`, `border-solid`, `border-dashed`, `border-dotted`, `border-double`

#### 5.3 è¾¹æ¡†å®½åº¦

- **åŠŸèƒ½**ï¼šæ”¯æŒå››è¾¹ç‹¬ç«‹è®¾ç½®
- **æ¨¡å¼**ï¼š
  - **æŠ˜å **ï¼šç»Ÿä¸€è®¾ç½®æ‰€æœ‰è¾¹ï¼ˆ`border` æˆ– `border-{value}`ï¼‰
  - **å±•å¼€**ï¼šå››è¾¹ç‹¬ç«‹ï¼ˆ`border-t-{value}`, `border-r-{value}`, `border-b-{value}`, `border-l-{value}`ï¼‰
- **é€‰é¡¹**ï¼š0px (border-0), 1px (border), 2px (border-2), 4px (border-4), 8px (border-8)

### 6. å¤–è§‚ âœ…

#### 6.1 é€æ˜åº¦ (Opacity)

- **é€‰é¡¹**ï¼š0, 5, 10, 20, 25, 30, 40, 50, 60, 70, 75, 80, 90, 95, 100
- **ç±»åæ˜ å°„**ï¼š`opacity-0`, `opacity-5`, `opacity-10`, ç­‰

#### 6.2 åœ†è§’ (Radius)

- **é€‰é¡¹**ï¼šNone, None (rounded-none), Small (rounded-sm), Default (rounded), Medium (rounded-md), Large (rounded-lg), XL (rounded-xl), 2XL (rounded-2xl), 3XL (rounded-3xl), Full (rounded-full)
- **ç±»åæ˜ å°„**ï¼š`rounded-none`, `rounded-sm`, `rounded`, `rounded-md`, ç­‰

#### 6.3 é˜´å½± (Shadow)

- **é€‰é¡¹**ï¼šNone, Small (shadow-sm), Default (shadow), Medium (shadow-md), Large (shadow-lg), XL (shadow-xl), 2XL (shadow-2xl), Inner (shadow-inner)
- **ç±»åæ˜ å°„**ï¼š`shadow-none`, `shadow-sm`, `shadow`, `shadow-md`, ç­‰

## å¾…å®ç°åŠŸèƒ½

### 1. æ–‡æœ¬è£…é¥° âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒæ–‡æœ¬è£…é¥°æ ·å¼ï¼ˆæ–œä½“ã€åˆ é™¤çº¿ã€ä¸‹åˆ’çº¿ã€ä¸Šåˆ’çº¿ï¼‰

**é¢„æœŸå®ç°**ï¼š

```typescript
// æ–‡æœ¬è£…é¥°é€‰é¡¹
const textDecorationOptions = [
  { label: 'Italic', value: 'italic', class: 'italic' },
  { label: 'Strikethrough', value: 'strikethrough', class: 'line-through' },
  { label: 'Underline', value: 'underline', class: 'underline' },
  { label: 'Overline', value: 'overline', class: 'overline' },
];

// å¤„ç†æ–‡æœ¬è£…é¥°å˜æ›´
const handleTextDecorationChange = (decoration: string) => {
  const newDecorations = textDecoration.includes(decoration)
    ? textDecoration.filter((d) => d !== decoration)
    : [...textDecoration, decoration];

  // ç”Ÿæˆç±»åå¹¶åº”ç”¨
  const decorationClasses = newDecorations
    .map((d) => textDecorationOptions.find((opt) => opt.value === d)?.class)
    .filter(Boolean)
    .join(' ');

  toggleStyle(decorationClasses, TEXT_DECORATION_REGEXP);
};
```

**ç›¸å…³æ–‡ä»¶**ï¼š

- `src/pages/AppDev/components/DesignViewer/index.tsx` (ç¬¬ 1456-1510 è¡Œå·²æ³¨é‡Š)

### 2. Typographyï¼ˆå­—ä½“æ—ï¼‰âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒé€‰æ‹©å­—ä½“æ—ï¼ˆSans Serif, Serif, Monospace ç­‰ï¼‰

**é¢„æœŸå®ç°**ï¼š

```typescript
// Typography é€‰é¡¹
const typographyOptions = [
  { label: 'Default', value: 'Default' },
  { label: 'Sans Serif', value: 'Sans Serif', class: 'font-sans' },
  { label: 'Serif', value: 'Serif', class: 'font-serif' },
  { label: 'Monospace', value: 'Monospace', class: 'font-mono' },
];

// å¤„ç† Typography å˜æ›´
const handleTypographyChange = (value: string) => {
  setLocalTypography(value);

  if (value === 'Default') {
    toggleStyle('', /^font-(sans|serif|mono)$/);
  } else {
    const typographyClass = typographyOptions.find(
      (opt) => opt.value === value,
    )?.class;
    if (typographyClass) {
      toggleStyle(typographyClass, /^font-(sans|serif|mono)$/);
    }
  }
};
```

**ç›¸å…³æ–‡ä»¶**ï¼š

- `src/pages/AppDev/components/DesignViewer/index.tsx` (ç¬¬ 1366-1374 è¡Œå·²æ³¨é‡Š)

### 3. æ›´å¤šæ“ä½œèœå• âŒ

**åŠŸèƒ½æè¿°**ï¼šæä¾›æ›´å¤šæ“ä½œé€‰é¡¹ï¼ˆå¤åˆ¶å±æ€§ã€é‡ç½®ã€åˆ é™¤ï¼‰

**é¢„æœŸå®ç°**ï¼š

```typescript
// æ›´å¤šæ“ä½œèœå•é¡¹
const moreMenuItems = [
  {
    key: 'copy',
    label: 'å¤åˆ¶å±æ€§',
    onClick: () => {
      // å¤åˆ¶å½“å‰å…ƒç´ çš„ className åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(selectedElement?.className || '');
      message.success('å±æ€§å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    },
  },
  {
    key: 'reset',
    label: 'é‡ç½®',
    onClick: () => {
      // é‡ç½®æ‰€æœ‰æ ·å¼åˆ°é»˜è®¤å€¼
      resetLocalStates();
      handleStyleUpdate('');
    },
  },
  {
    key: 'delete',
    label: 'åˆ é™¤',
    onClick: () => {
      // åˆ é™¤å½“å‰å…ƒç´ ï¼ˆéœ€è¦ iframe æ”¯æŒï¼‰
      // å‘é€ DELETE_ELEMENT æ¶ˆæ¯åˆ° iframe
    },
  },
];
```

**ç›¸å…³æ–‡ä»¶**ï¼š

- `src/pages/AppDev/components/DesignViewer/index.tsx` (ç¬¬ 1342-1348 è¡Œå·²æ³¨é‡Š)

### 4. è¾¹æ¡†å››è¾¹ç‹¬ç«‹é¢œè‰² âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒä¸ºè¾¹æ¡†çš„å››ä¸ªè¾¹è®¾ç½®ä¸åŒçš„é¢œè‰²

**é¢„æœŸå®ç°**ï¼š

```typescript
// è¾¹æ¡†é¢œè‰²çŠ¶æ€ï¼ˆå››è¾¹ç‹¬ç«‹ï¼‰
const [localBorderColor, setLocalBorderColor] = useState<SpaceValueType>({
  top: 'Default',
  right: 'Default',
  bottom: 'Default',
  left: 'Default',
});

// å¤„ç†è¾¹æ¡†é¢œè‰²å˜æ›´ï¼ˆå››è¾¹ç‹¬ç«‹ï¼‰
const handleBorderColorChange = (
  type: 'top' | 'right' | 'bottom' | 'left' | 'all',
  color: string,
) => {
  const newBorderColor = { ...localBorderColor };
  if (type === 'all') {
    newBorderColor.top = color;
    newBorderColor.right = color;
    newBorderColor.bottom = color;
    newBorderColor.left = color;
  } else {
    newBorderColor[type] = color;
  }
  setLocalBorderColor(newBorderColor);

  // ç”Ÿæˆç±»åï¼šborder-t-{color}, border-r-{color}, ç­‰
  // æ³¨æ„ï¼šTailwind é»˜è®¤ä¸æ”¯æŒå››è¾¹ç‹¬ç«‹é¢œè‰²ï¼Œå¯èƒ½éœ€è¦è‡ªå®šä¹‰é…ç½®
};
```

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- Tailwind CSS é»˜è®¤ä¸æ”¯æŒå››è¾¹ç‹¬ç«‹çš„è¾¹æ¡†é¢œè‰²
- éœ€è¦è‡ªå®šä¹‰ Tailwind é…ç½®æˆ–ä½¿ç”¨ CSS å˜é‡

### 5. æ¸å˜èƒŒæ™¯ âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒè®¾ç½®æ¸å˜èƒŒæ™¯

**é¢„æœŸå®ç°**ï¼š

```typescript
// æ¸å˜ç±»å‹é€‰é¡¹
const gradientOptions = [
  { label: 'None', value: 'none' },
  { label: 'Linear', value: 'linear' },
  { label: 'Radial', value: 'radial' },
  { label: 'Conic', value: 'conic' },
];

// æ¸å˜æ–¹å‘é€‰é¡¹ï¼ˆLinearï¼‰
const gradientDirectionOptions = [
  { label: 'To Right', value: 'to-r', class: 'bg-gradient-to-r' },
  { label: 'To Left', value: 'to-l', class: 'bg-gradient-to-l' },
  { label: 'To Top', value: 'to-t', class: 'bg-gradient-to-t' },
  { label: 'To Bottom', value: 'to-b', class: 'bg-gradient-to-b' },
  // ... æ›´å¤šæ–¹å‘
];
```

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š

- éœ€è¦æ”¯æŒå¤šä¸ªé¢œè‰²åœæ­¢ç‚¹
- éœ€è¦å¤„ç†æ¸å˜æ–¹å‘å’Œè§’åº¦

### 6. å˜æ¢æ•ˆæœ âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒå˜æ¢æ•ˆæœï¼ˆæ—‹è½¬ã€ç¼©æ”¾ã€å€¾æ–œã€å¹³ç§»ï¼‰

**é¢„æœŸå®ç°**ï¼š

```typescript
// å˜æ¢é€‰é¡¹
const transformOptions = {
  rotate: ['0', '1', '2', '3', '6', '12', '45', '90', '180'],
  scale: ['0', '50', '75', '90', '95', '100', '105', '110', '125', '150'],
  skew: ['0', '1', '2', '3', '6', '12'],
  translate: [
    '0',
    '1',
    '2',
    '3',
    '4',
    '5',
    '6',
    '8',
    '10',
    '12',
    '16',
    '20',
    '24',
  ],
};
```

### 7. åŠ¨ç”»æ•ˆæœ âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒåŠ¨ç”»æ•ˆæœï¼ˆæ·¡å…¥ã€æ·¡å‡ºã€æ»‘åŠ¨ç­‰ï¼‰

**é¢„æœŸå®ç°**ï¼š

```typescript
// åŠ¨ç”»é€‰é¡¹
const animationOptions = [
  { label: 'None', value: 'none' },
  { label: 'Spin', value: 'spin', class: 'animate-spin' },
  { label: 'Ping', value: 'ping', class: 'animate-ping' },
  { label: 'Pulse', value: 'pulse', class: 'animate-pulse' },
  { label: 'Bounce', value: 'bounce', class: 'animate-bounce' },
];
```

### 8. å“åº”å¼è®¾è®¡ âŒ

**åŠŸèƒ½æè¿°**ï¼šæ”¯æŒå“åº”å¼æ–­ç‚¹è®¾ç½®ï¼ˆsm, md, lg, xl, 2xlï¼‰

**é¢„æœŸå®ç°**ï¼š

```typescript
// å“åº”å¼æ–­ç‚¹é€‰é¡¹
const breakpointOptions = [
  { label: 'Default', value: 'default' },
  { label: 'SM (640px)', value: 'sm' },
  { label: 'MD (768px)', value: 'md' },
  { label: 'LG (1024px)', value: 'lg' },
  { label: 'XL (1280px)', value: 'xl' },
  { label: '2XL (1536px)', value: '2xl' },
];

// å¤„ç†å“åº”å¼æ ·å¼
const handleResponsiveStyleChange = (
  breakpoint: string,
  styleType: string,
  value: string,
) => {
  // ç”Ÿæˆå“åº”å¼ç±»åï¼Œå¦‚ md:text-lg, lg:bg-blue-500
  const responsiveClass =
    breakpoint === 'default'
      ? `${styleType}-${value}`
      : `${breakpoint}:${styleType}-${value}`;

  toggleStyle(responsiveClass, RESPONSIVE_STYLE_REGEXP);
};
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Tailwind ç±»åè§£æ

#### 1.1 é—´è·è§£æ

```typescript
// ä» Tailwind ç±»åä¸­è§£æé—´è·å€¼
export const parseTailwindSpacing = (className: string): string => {
  // åŒ¹é…ç±»åä¸­çš„æ•°å­—éƒ¨åˆ†ï¼Œå¦‚ "p-4" ä¸­çš„ "4"
  const match = className.match(/-(\d+(?:\.\d+)?|px)$/);
  if (match) {
    return match[1].toString();
  }
  return '0';
};
```

#### 1.2 é¢œè‰²è§£æ

```typescript
// ä» Tailwind é¢œè‰²ç±»åä¸­è·å–å®é™…é¢œè‰²å€¼
export const getColorFromTailwindClass = (
  className: string,
  callback: (color: string | null) => void,
) => {
  // 1. å¤„ç†ç‰¹æ®Šå€¼ï¼ˆtransparent, black, whiteï¼‰
  if (className === 'transparent') {
    callback('transparent');
    return;
  }

  // 2. ä»é¢œè‰²æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾
  const colorOptions = generateFullTailwindColorOptions();
  const colorClass = className.replace(/^(text|bg|border)-/, '');
  const matchedOption = colorOptions.find((opt) => opt.label === colorClass);

  if (matchedOption) {
    callback(matchedOption.value);
  } else {
    callback('Default');
  }
};
```

#### 1.3 å­—ä½“å¤§å°è§£æ

```typescript
// ä» Tailwind å­—ä½“å¤§å°ç±»åä¸­è§£æ
export const parseTailwindFontSize = (className: string): string | null => {
  // åŒ¹é… text-xs, text-sm, text-base, text-lg, text-xl, text-2xl ç­‰
  const match = className.match(
    /^text-(xs|sm|base|lg|xl|2xl|3xl|4xl|5xl|6xl|7xl|8xl|9xl)$/,
  );
  if (match) {
    return match[1];
  }
  return null;
};
```

### 2. æ ·å¼åˆ‡æ¢é€»è¾‘

#### 2.1 é¿å…æ ·å¼å†²çª

```typescript
const toggleStyle = (
  newStyle: string,
  regex: RegExp,
  attribute?: toggleStyleAttributeType,
) => {
  const currentClasses = editingClass.split(' ').filter((c) => c.trim());

  // ç‰¹æ®Šå¤„ç†ï¼šé¿å…è¯¯åˆ å…¶ä»–æ ·å¼
  const filterCurrentClasses = currentClasses.filter((c) => {
    if (attribute === 'fontSize') {
      // ä¿ç•™ text-center ç­‰éå­—ä½“å¤§å°çš„ text- ç±»å
      const matchesFontSize = regex.test(c);
      if (c === 'text-center' || (c.startsWith('text-') && !matchesFontSize)) {
        return true;
      }
      return !matchesFontSize;
    } else if (attribute === 'textAlign') {
      // åªç§»é™¤æ–‡æœ¬å¯¹é½ç±»åï¼Œä¿ç•™å…¶ä»– text- ç±»å
      const matchesTextAlign = regex.test(c);
      if (matchesTextAlign) {
        return false;
      }
      return true;
    } else {
      // å…¶ä»–æƒ…å†µï¼šæ’é™¤å­—ä½“å¤§å°ç›¸å…³çš„ç±»å
      const fontSizeClasses = fontSizeOptions
        .filter((option) => option.value !== 'Default')
        .map((option) => `text-${option.value}`);
      if (fontSizeClasses.includes(c) || c.includes('text-center')) {
        return true;
      }
      return !regex.test(c);
    }
  });

  // æ·»åŠ æ–°æ ·å¼
  if (newStyle) {
    filterCurrentClasses.push(newStyle);
  }

  const finalClasses = filterCurrentClasses.join(' ');
  setEditingClass(finalClasses);
  handleStyleUpdate(finalClasses);
};
```

#### 2.2 å››è¾¹ç‹¬ç«‹æ ·å¼å¤„ç†

```typescript
// å¤„ç†å››è¾¹ç‹¬ç«‹çš„æ ·å¼ï¼ˆå¦‚ margin, padding, border-widthï¼‰
const handleMarginChange = (
  type: PaddingOrMarginType,
  value: string | null,
) => {
  if (value !== null) {
    const { spaceObject: newMargin, prefix } = getPaddingOrMarginSpace(
      type,
      value,
      'margin',
      localMargin,
    );
    setLocalMargin(newMargin);

    // ç”Ÿæˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œç²¾ç¡®åŒ¹é…ç›¸åŒå‰ç¼€
    const marginRegex =
      prefix === 'm'
        ? /^m-(?![xytrbl])/ // m- åé¢ä¸èƒ½æ˜¯ xã€yã€tã€rã€bã€l
        : new RegExp(`^${prefix}-`);

    toggleStyle(`${prefix}-${value}`, marginRegex);
  }
};
```

### 3. å˜æ›´è¿½è¸ª

#### 3.1 æ·»åŠ å˜æ›´

```typescript
const upsertPendingChange = (
  type: 'style' | 'content',
  newValue: string,
  originalValue?: string,
) => {
  if (!selectedElement) return;

  setPendingChanges((prev: any) => {
    // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒä½ç½®çš„å˜æ›´
    const existingIndex = prev.findIndex(
      (item: any) =>
        item.type === type &&
        item.sourceInfo.fileName === selectedElement.sourceInfo.fileName &&
        item.sourceInfo.lineNumber === selectedElement.sourceInfo.lineNumber,
    );

    const newChange = {
      type,
      sourceInfo: selectedElement.sourceInfo,
      newValue,
      originalValue:
        originalValue ||
        (type === 'style'
          ? selectedElement.className
          : selectedElement.textContent),
    };

    // å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°ï¼›å¦åˆ™æ·»åŠ 
    if (existingIndex >= 0) {
      const newList = [...prev];
      newList[existingIndex] = newChange;
      return newList;
    } else {
      return [...prev, newChange];
    }
  });
};
```

#### 3.2 åº”ç”¨å˜æ›´

```typescript
export const applyDesignChanges = async (
  fileContent: string,
  changes: Array<{
    type: 'style' | 'content';
    sourceInfo: SourceInfo;
    newValue: string;
    originalValue?: string;
  }>,
): Promise<string> => {
  let updatedContent = fileContent;

  // æŒ‰ä½ç½®ä»åå¾€å‰æ’åºï¼Œé˜²æ­¢ç´¢å¼•åç§»
  const sortedChanges = [...changes].sort((a, b) => {
    if (a.sourceInfo.lineNumber !== b.sourceInfo.lineNumber) {
      return b.sourceInfo.lineNumber - a.sourceInfo.lineNumber;
    }
    return b.sourceInfo.columnNumber - a.sourceInfo.columnNumber;
  });

  // åº”ç”¨æ¯ä¸ªä¿®æ”¹
  for (const change of sortedChanges) {
    try {
      updatedContent = await smartReplaceInSource(updatedContent, {
        lineNumber: change.sourceInfo.lineNumber,
        columnNumber: change.sourceInfo.columnNumber,
        newValue: change.newValue,
        originalValue: change.originalValue,
        type: change.type,
        tagName: change.sourceInfo.elementType,
      });
    } catch (error) {
      console.error('[DesignViewer] Apply change failed:', error, change);
      // ç»§ç»­å¤„ç†å…¶ä»–ä¿®æ”¹
    }
  }

  return updatedContent;
};
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**: å…³äº `smartReplaceInSource` å‡½æ•°çš„æŸ¥æ‰¾æ›¿æ¢è§„åˆ™ã€æ”¯æŒçš„ç”¨ä¾‹å’Œæµ‹è¯•åœºæ™¯ï¼Œè¯·å‚è€ƒ [æŸ¥æ‰¾æ›¿æ¢è§„åˆ™ç”¨ä¾‹æ–‡æ¡£](./DesignViewer-Replacement-Rules.md)ã€‚

### 4. æ¶ˆæ¯é€šä¿¡

#### 4.1 æ¶ˆæ¯ç›‘å¬

```typescript
useEffect(() => {
  const handleMessage = (event: MessageEvent) => {
    const { type, payload } = event.data;

    switch (type) {
      case 'ELEMENT_SELECTED':
        // å¤„ç†å…ƒç´ é€‰æ‹©
        const elementInfo = payload.elementInfo;
        setSelectedElement(elementInfo);
        if (elementInfo.className) {
          parseTailwindClassesAndUpdateStates(elementInfo.className);
        }
        break;

      case 'CONTENT_UPDATED':
        // å¤„ç†å†…å®¹æ›´æ–°
        setLocalTextContent(payload.newValue);
        upsertPendingChange('content', payload.newValue, payload.oldValue);
        break;

      case 'DESIGN_MODE_CHANGED':
        // å¤„ç†è®¾è®¡æ¨¡å¼çŠ¶æ€å˜åŒ–
        setIframeDesignMode(event.data.enabled);
        if (!event.data.enabled) {
          setSelectedElement(null);
        }
        break;
    }
  };

  window.addEventListener('message', handleMessage);
  return () => {
    window.removeEventListener('message', handleMessage);
  };
}, []);
```

#### 4.2 æ¶ˆæ¯å‘é€

```typescript
// å‘é€æ ·å¼æ›´æ–°æ¶ˆæ¯
const handleStyleUpdate = (newClass: string) => {
  upsertPendingChange('style', newClass);

  const iframe = document.querySelector('iframe');
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage(
      {
        type: 'UPDATE_STYLE',
        payload: {
          sourceInfo: selectedElement?.sourceInfo,
          newClass,
          persist: false, // ä¸æŒä¹…åŒ–ï¼Œä»…é¢„è§ˆ
        },
        timestamp: Date.now(),
      },
      '*',
    );
  }
};

// å‘é€å†…å®¹æ›´æ–°æ¶ˆæ¯
const handleContentUpdate = (newContent: string) => {
  if (!selectedElement) return;

  upsertPendingChange('content', newContent);

  const iframe = document.querySelector('iframe');
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage(
      {
        type: 'UPDATE_CONTENT',
        payload: {
          sourceInfo: selectedElement?.sourceInfo,
          newContent,
          persist: false,
        },
        timestamp: Date.now(),
      },
      '*',
    );
  }
};
```

## å¼€å‘è§„èŒƒ

### 1. æ–‡ä»¶å‘½åè§„èŒƒ

- **ç»„ä»¶æ–‡ä»¶**ï¼š`ComponentName/index.tsx`
- **æ ·å¼æ–‡ä»¶**ï¼š`ComponentName/index.less`
- **å·¥å…·æ–‡ä»¶**ï¼š`utils/tailwind-{feature}.ts`
- **ç±»å‹æ–‡ä»¶**ï¼š`messages.ts`ï¼ˆç»Ÿä¸€ç®¡ç†æ¶ˆæ¯ç±»å‹ï¼‰

### 2. ä»£ç ç»„ç»‡è§„èŒƒ

```typescript
// 1. å¯¼å…¥å¤–éƒ¨ä¾èµ–
import React from 'react';
import { Button, Input } from 'antd';

// 2. å¯¼å…¥å†…éƒ¨ä¾èµ–
import { useModel } from 'umi';
import { ElementInfo } from './messages';

// 3. ç±»å‹å®šä¹‰
interface ComponentProps {
  // ...
}

// 4. ç»„ä»¶å®ç°
const Component: React.FC<ComponentProps> = ({ ...props }) => {
  // ...
};

// 5. å¯¼å‡º
export default Component;
```

### 3. çŠ¶æ€ç®¡ç†è§„èŒƒ

- **æœ¬åœ°çŠ¶æ€**ï¼šä½¿ç”¨ `useState` ç®¡ç†ç»„ä»¶å†…éƒ¨çŠ¶æ€
- **å…¨å±€çŠ¶æ€**ï¼šä½¿ç”¨ UmiJS Model ç®¡ç†è·¨ç»„ä»¶çŠ¶æ€
- **çŠ¶æ€å‘½å**ï¼šä½¿ç”¨æè¿°æ€§å‘½åï¼Œå¦‚ `localColor`, `isMarginLocked`

### 4. æ ·å¼å¤„ç†è§„èŒƒ

- **Tailwind ç±»å**ï¼šç»Ÿä¸€ä½¿ç”¨ Tailwind CSS ç±»åç³»ç»Ÿ
- **ç±»åç”Ÿæˆ**ï¼šé€šè¿‡å·¥å…·å‡½æ•°ç”Ÿæˆï¼Œé¿å…ç¡¬ç¼–ç 
- **æ ·å¼åˆ‡æ¢**ï¼šä½¿ç”¨ `toggleStyle()` æ–¹æ³•ç»Ÿä¸€å¤„ç†

### 5. æ¶ˆæ¯é€šä¿¡è§„èŒƒ

- **æ¶ˆæ¯ç±»å‹**ï¼šåœ¨ `messages.ts` ä¸­ç»Ÿä¸€å®šä¹‰
- **æ¶ˆæ¯éªŒè¯**ï¼šéªŒè¯ `sourceInfo` çš„æœ‰æ•ˆæ€§
- **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…å¤„ç†æ¶ˆæ¯å‘é€å¤±è´¥çš„æƒ…å†µ

### 6. å·¥å…·å‡½æ•°è§„èŒƒ

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå·¥å…·å‡½æ•°åªå¤„ç†ä¸€ä¸ªåŠŸèƒ½
- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript ç±»å‹æ³¨è§£
- **æ–‡æ¡£æ³¨é‡Š**ï¼šä¸ºæ¯ä¸ªå‡½æ•°æ·»åŠ  JSDoc æ³¨é‡Š

## å¸¸è§é—®é¢˜

### 0. æ’ä»¶æœªå®‰è£…æˆ–é…ç½®é”™è¯¯

**é—®é¢˜**ï¼šè®¾è®¡æ¨¡å¼æ— æ³•æ­£å¸¸å·¥ä½œï¼Œç‚¹å‡»å…ƒç´ æ²¡æœ‰ååº”ï¼Œæˆ–è€…æ— æ³•è·å–æºç æ˜ å°„ä¿¡æ¯

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²å®‰è£…**

   ```bash
   # æ£€æŸ¥ package.json ä¸­æ˜¯å¦åŒ…å«æ’ä»¶ä¾èµ–
   cat package.json | grep vite-plugin-design-mode
   ```

2. **æ£€æŸ¥ Vite é…ç½®**

   ```typescript
   // æ£€æŸ¥ vite.config.ts ä¸­æ˜¯å¦åŒ…å«æ’ä»¶é…ç½®
   import appdevDesignMode from '@xagi/vite-plugin-design-mode';

   export default defineConfig({
     plugins: [
       react(),
       appdevDesignMode(), // å¿…é¡»åŒ…å«æ­¤é…ç½®
     ],
   });
   ```

3. **æ£€æŸ¥å…ƒç´ æ˜¯å¦åŒ…å«æºç æ˜ å°„å±æ€§**

   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ£€æŸ¥å…ƒç´ 
   const element = document.querySelector('.my-element');
   const prefix = 'data-xagi'; // æˆ–ä» window.__APPDEV_DESIGN_MODE_CONFIG__ è·å–
   const sourceInfo = element.getAttribute(`${prefix}-info`);

   if (sourceInfo) {
     const sourceData = JSON.parse(sourceInfo);
     console.log('æºç æ˜ å°„ä¿¡æ¯:', sourceData);
     // åº”è¯¥è¾“å‡ºåŒ…å« fileName, lineNumber, columnNumber, elementType ç­‰çš„å¯¹è±¡
     // {
     //   fileName: 'src/App.tsx',
     //   lineNumber: 10,
     //   columnNumber: 5,
     //   elementType: 'div',
     //   componentName: 'App',
     //   elementId: 'src/App.tsx:10:5_div',
     //   ...
     // }
   } else {
     console.error('æœªæ‰¾åˆ°æºç æ˜ å°„å±æ€§ï¼Œæ’ä»¶å¯èƒ½æœªæ­£ç¡®å®‰è£…');
   }

   // æ£€æŸ¥é™æ€å†…å®¹æ ‡è®°
   const isEditable =
     element.getAttribute(`${prefix}-static-content`) === 'true';
   console.log('æ˜¯å¦å¯ç¼–è¾‘:', isEditable);
   ```

4. **æ£€æŸ¥å¼€å‘æœåŠ¡æ˜¯å¦åœ¨æ’ä»¶å®‰è£…åé‡å¯**
   - æ’ä»¶å¿…é¡»åœ¨å¯åŠ¨å¼€å‘æœåŠ¡ä¹‹å‰å®‰è£…
   - å¦‚æœæœåŠ¡å·²åœ¨è¿è¡Œï¼Œéœ€è¦å…ˆåœæ­¢æœåŠ¡ï¼Œå®‰è£…æ’ä»¶åå†é‡æ–°å¯åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. å®‰è£…æ’ä»¶ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
pnpm dlx @xagi/vite-plugin-design-mode@latest install

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. åœæ­¢å½“å‰å¼€å‘æœåŠ¡ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
# Ctrl+C æˆ– kill è¿›ç¨‹

# 4. é‡æ–°å¯åŠ¨å¼€å‘æœåŠ¡
pnpm dev
```

**éªŒè¯å®‰è£…ï¼š**

å®‰è£…å®Œæˆåï¼Œåœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æ£€æŸ¥å…ƒç´ ï¼Œåº”è¯¥èƒ½çœ‹åˆ° `data-xagi-*` å±æ€§ï¼š

```html
<div
  class="my-element"
  data-xagi-info='{"fileName":"src/App.tsx","lineNumber":10,"columnNumber":5,"elementType":"div","componentName":"App","elementId":"src/App.tsx:10:5_div","isUIComponent":false}'
  data-xagi-element-id="src/App.tsx:10:5_div"
  data-xagi-position="10:5"
  data-xagi-static-content="true"
  data-xagi-static-class="true"
>
  Content
</div>
```

**æ³¨æ„**ï¼šä¸ºäº†å‡å°‘ DOM ä½“ç§¯ï¼Œæ’ä»¶é‡‡ç”¨äº†ç´§å‡‘çš„å±æ€§ç­–ç•¥ã€‚æ‰€æœ‰ä¸»è¦ä¿¡æ¯ï¼ˆå¦‚ `fileName`ã€`lineNumber`ã€`columnNumber` ç­‰ï¼‰éƒ½åŒ…å«åœ¨ `data-xagi-info` JSON å±æ€§ä¸­ï¼Œä¸å†å•ç‹¬æ³¨å…¥ `data-xagi-file`ã€`data-xagi-line`ã€`data-xagi-column` ç­‰å±æ€§ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡è§£æ `data-xagi-info` JSON å­—ç¬¦ä¸²è·å–ã€‚

### 1. æ ·å¼ä¸ç”Ÿæ•ˆ

**é—®é¢˜**ï¼šä¿®æ”¹æ ·å¼åï¼Œiframe ä¸­æ²¡æœ‰çœ‹åˆ°æ•ˆæœ

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ iframe æ˜¯å¦æ­£ç¡®æ¥æ”¶æ¶ˆæ¯
2. æ£€æŸ¥ Tailwind CSS ç±»åæ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥ iframe ä¸­æ˜¯å¦åŠ è½½äº† Tailwind CSS
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ·»åŠ è°ƒè¯•æ—¥å¿—
const handleStyleUpdate = (newClass: string) => {
  console.log('[DesignViewer] Updating style:', newClass);

  const iframe = document.querySelector('iframe');
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage(
      {
        type: 'UPDATE_STYLE',
        payload: {
          sourceInfo: selectedElement?.sourceInfo,
          newClass,
          persist: false,
        },
        timestamp: Date.now(),
      },
      '*',
    );

    console.log('[DesignViewer] Message sent to iframe');
  } else {
    console.error('[DesignViewer] Iframe not found');
  }
};
```

### 2. æ ·å¼å†²çª

**é—®é¢˜**ï¼šä¿®æ”¹ä¸€ä¸ªæ ·å¼æ—¶ï¼Œå…¶ä»–æ ·å¼è¢«æ„å¤–åˆ é™¤

**åŸå› **ï¼šæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¿‡äºå®½æ³›

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼
const toggleStyle = (newStyle: string, regex: RegExp, attribute?: string) => {
  const currentClasses = editingClass.split(' ').filter((c) => c.trim());

  // ç‰¹æ®Šå¤„ç†ï¼šé¿å…è¯¯åˆ å…¶ä»–æ ·å¼
  const filterCurrentClasses = currentClasses.filter((c) => {
    if (attribute === 'fontSize') {
      // ä¿ç•™ text-center ç­‰éå­—ä½“å¤§å°çš„ text- ç±»å
      const matchesFontSize = regex.test(c);
      if (c === 'text-center' || (c.startsWith('text-') && !matchesFontSize)) {
        return true;
      }
      return !matchesFontSize;
    }
    return !regex.test(c);
  });

  // ...
};
```

### 3. å˜æ›´æœªä¿å­˜

**é—®é¢˜**ï¼šä¿®æ”¹æ ·å¼åï¼Œä¿å­˜æ—¶æ²¡æœ‰åº”ç”¨åˆ°æºä»£ç 

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ `pendingChanges` æ˜¯å¦æ­£ç¡®è®°å½•
2. æ£€æŸ¥ `applyDesignChanges` æ˜¯å¦è¢«è°ƒç”¨
3. æ£€æŸ¥ `smartReplaceInSource` æ˜¯å¦æ­£ç¡®æ‰§è¡Œ
4. æ£€æŸ¥ `sourceInfo` æ˜¯å¦æœ‰æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ·»åŠ å˜æ›´è¿½è¸ªæ—¥å¿—
const upsertPendingChange = (type: 'style' | 'content', newValue: string) => {
  console.log('[DesignViewer] Upserting change:', { type, newValue });

  setPendingChanges((prev: any) => {
    // ...
    console.log('[DesignViewer] Pending changes:', newList);
    return newList;
  });
};
```

### 4. å…ƒç´ é€‰æ‹©å¤±è´¥

**é—®é¢˜**ï¼šç‚¹å‡» iframe ä¸­çš„å…ƒç´ æ—¶ï¼ŒDesignViewer æ²¡æœ‰å“åº”

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥è®¾è®¡æ¨¡å¼æ˜¯å¦å·²å¯ç”¨
2. æ£€æŸ¥ iframe æ˜¯å¦æ­£ç¡®å‘é€æ¶ˆæ¯
3. æ£€æŸ¥æ¶ˆæ¯ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®æ³¨å†Œ
4. æ£€æŸ¥ `sourceInfo` æ˜¯å¦æœ‰æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ·»åŠ æ¶ˆæ¯ç›‘å¬è°ƒè¯•
useEffect(() => {
  const handleMessage = (event: MessageEvent) => {
    console.log('[DesignViewer] Received message:', event.data);

    if (event.data.type === 'ELEMENT_SELECTED') {
      const { elementInfo } = event.data.payload;
      console.log('[DesignViewer] Element selected:', elementInfo);

      // éªŒè¯ sourceInfo
      if (
        !elementInfo?.sourceInfo?.fileName ||
        elementInfo.sourceInfo.lineNumber === 0
      ) {
        console.error('[DesignViewer] Invalid sourceInfo:', elementInfo);
        return;
      }

      setSelectedElement(elementInfo);
      // ...
    }
  };

  window.addEventListener('message', handleMessage);
  return () => window.removeEventListener('message', handleMessage);
}, []);
```

### 5. æ€§èƒ½é—®é¢˜

**é—®é¢˜**ï¼šé¢‘ç¹ä¿®æ”¹æ ·å¼æ—¶ï¼Œé¡µé¢å¡é¡¿

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// ä½¿ç”¨é˜²æŠ–å¤„ç†é¢‘ç¹çš„æ ·å¼æ›´æ–°
import { debounce } from 'lodash';

const debouncedStyleUpdate = useMemo(
  () =>
    debounce((newClass: string) => {
      const iframe = document.querySelector('iframe');
      if (iframe?.contentWindow) {
        iframe.contentWindow.postMessage(
          {
            type: 'UPDATE_STYLE',
            payload: {
              sourceInfo: selectedElement?.sourceInfo,
              newClass,
              persist: false,
            },
            timestamp: Date.now(),
          },
          '*',
        );
      }
    }, 100),
  [selectedElement],
);

// ä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬
const handleStyleUpdate = (newClass: string) => {
  upsertPendingChange('style', newClass);
  debouncedStyleUpdate(newClass);
};
```

## æ€»ç»“

DesignViewer çš„ Design æ¨¡å¼æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–è®¾è®¡ç¼–è¾‘å™¨ï¼Œé€šè¿‡ Tailwind CSS ç±»åç³»ç»Ÿå®ç°äº†æ‰€è§å³æ‰€å¾—çš„è®¾è®¡ä½“éªŒã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å…¶æ¶æ„è®¾è®¡ã€æ ¸å¿ƒåŠŸèƒ½ã€å·¥ä½œæµç¨‹ã€æŠ€æœ¯å®ç°ç»†èŠ‚å’Œå¼€å‘è§„èŒƒï¼Œå¸Œæœ›èƒ½å¸®åŠ©å…¶ä»–åŒå­¦æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚

### å…³é”®è¦ç‚¹

1. **åŸºäº Tailwind CSS**ï¼šæ‰€æœ‰æ ·å¼éƒ½é€šè¿‡ Tailwind CSS ç±»åå®ç°
2. **åŒå‘åŒæ­¥**ï¼šæ”¯æŒä»æºä»£ç è§£ææ ·å¼ï¼Œä¹Ÿæ”¯æŒå°†ä¿®æ”¹å†™å›æºä»£ç 
3. **å®æ—¶é¢„è§ˆ**ï¼šé€šè¿‡ postMessage å®ç°ä¸ iframe çš„å®æ—¶é€šä¿¡
4. **å˜æ›´è¿½è¸ª**ï¼šæ‰€æœ‰ä¿®æ”¹è®°å½•åœ¨ pendingChanges ä¸­ï¼Œæ”¯æŒæ‰¹é‡ä¿å­˜
5. **å…ƒç´ å®šä½**ï¼šé€šè¿‡ sourceInfo ç²¾ç¡®å®šä½å…ƒç´ åœ¨æºä»£ç ä¸­çš„ä½ç½®

### åç»­ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµä¼˜åŒ–é¢‘ç¹çš„æ ·å¼æ›´æ–°
2. **åŠŸèƒ½æ‰©å±•**ï¼šå®ç°æ›´å¤šæ ·å¼é€‰é¡¹ï¼ˆæ–‡æœ¬è£…é¥°ã€æ¸å˜ã€åŠ¨ç”»ç­‰ï¼‰
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ·»åŠ æ’¤é”€/é‡åšåŠŸèƒ½ã€æ ·å¼é¢„è®¾ã€æ‰¹é‡æ“ä½œç­‰
4. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
5. **å“åº”å¼æ”¯æŒ**ï¼šæ”¯æŒå“åº”å¼æ–­ç‚¹è®¾ç½®

## ç›¸å…³æ–‡æ¡£

- [æŸ¥æ‰¾æ›¿æ¢è§„åˆ™ç”¨ä¾‹æ–‡æ¡£](./DesignViewer-Replacement-Rules.md) - è¯¦ç»†æ¢³ç†äº† `applyDesignChanges.ts` ä¸­ä½¿ç”¨çš„æŸ¥æ‰¾æ›¿æ¢è§„åˆ™ã€å·²æ”¯æŒçš„ç”¨ä¾‹å’Œè¯¦ç»†æµ‹è¯•åœºæ™¯ã€‚åŒ…å«æ ·å¼æ›¿æ¢ã€å†…å®¹æ›¿æ¢ã€å±æ€§æ›¿æ¢çš„å®Œæ•´è§„åˆ™è¯´æ˜ï¼Œä»¥åŠå¤šè¡Œå†…å®¹æ›¿æ¢ã€æ¨¡ç³Šæ ‡ç­¾åŒ¹é…ã€dangerouslySetInnerHTML å¤„ç†ç­‰å…³é”®åœºæ™¯çš„æµ‹è¯•ç”¨ä¾‹ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0  
**æœ€åæ›´æ–°**ï¼š2025-12-09  
**ç»´æŠ¤è€…**ï¼šDesignViewer å¼€å‘å›¢é˜Ÿ
